# OPSドメイン E2Eテスト仕様書

最終更新: 2025-10-18

## 📋 概要

OPSドメイン（`ops.local.test:3000`）は**運用担当者（OPS権限）専用のシステム管理ダッシュボード**です。システム全体の組織・ユーザー管理、監視、統計情報の確認を行います。**IP制限**により、許可されたIPアドレスからのみアクセス可能です。

## 🎯 テスト対象機能

### Phase 1: MVP（最小限の実装）

| 機能 | 説明 | 優先度 |
|------|------|--------|
| **OPS専用ログイン** | `ops.local.test:3000/login` での認証 | 🔴 高 |
| **IP制限チェック** | 許可されたIPアドレスのみアクセス可能 | 🔴 高 |
| **全組織一覧表示** | システム内のすべての組織を一覧表示 | 🔴 高 |
| **全ユーザー一覧表示** | システム内のすべてのユーザーを一覧表示 | 🔴 高 |

### Phase 2: 機能拡張（MVP後）

| 機能 | 説明 | 優先度 |
|------|------|--------|
| **組織詳細の確認・編集** | 個別組織の詳細情報表示と編集 | 🟡 中 |
| **ユーザー詳細の確認・編集** | 個別ユーザーの詳細情報表示と編集 | 🟡 中 |
| **システム統計情報** | 総組織数、総ユーザー数、プラン別統計など | 🟡 中 |
| **システムログ閲覧** | システム全体のエラーログ、監査ログ | 🟢 低 |

## 🧪 テストケース

---

### **1. OPS専用ログイン**

#### **1-1. OPS権限ユーザーのログイン成功**

**前提条件:**
- テストアカウント: `ops@example.com` / `test1234`
- IPアドレス: 許可リストに含まれる（または開発環境でIP制限なし）

**操作手順:**
1. OPSドメイン（`ops.local.test:3000/login`）にアクセス
2. メールアドレス「ops@example.com」を入力
3. パスワード「test1234」を入力
4. 「ログイン」ボタンをクリック

**期待結果:**
- ✅ ログインに成功する
- ✅ OPSドメインのダッシュボード（`ops.local.test:3000`）にリダイレクト
- ✅ ヘッダーに「OPS Dashboard」などのタイトルが表示される
- ✅ ダークテーマ（黒・赤系）のデザインが適用される

#### **1-2. 一般ユーザーがOPSログインを試みる**

**前提条件:**
- テストアカウント: `owner@example.com` / `test1234`（OPS権限なし）

**操作手順:**
1. OPSドメイン（`ops.local.test:3000/login`）にアクセス
2. メールアドレス「owner@example.com」を入力
3. パスワード「test1234」を入力
4. 「ログイン」ボタンをクリック

**期待結果:**
- ✅ エラーメッセージ「OPS権限がありません」が表示される
- ✅ OPSドメインにアクセスできない
- ✅ WWWドメインのログインページにリダイレクトされる

#### **1-3. OPS権限ユーザーがWWWドメインでログイン**

**前提条件:**
- テストアカウント: `ops@example.com` / `test1234`

**操作手順:**
1. WWWドメイン（`www.local.test:3000/login`）でログイン

**期待結果:**
- ✅ ログインに成功する
- ✅ 自動的にOPSドメイン（`ops.local.test:3000`）にリダイレクトされる

---

### **2. IP制限チェック**

#### **2-1. 許可されたIPアドレスからのアクセス**

**前提条件:**
- 環境変数 `OPS_ALLOWED_IPS` に自分のIPアドレスが含まれる
- 例: `OPS_ALLOWED_IPS=192.168.1.100,10.0.0.50`

**操作手順:**
1. 許可されたIPアドレス（例: 192.168.1.100）からOPSドメインにアクセス

**期待結果:**
- ✅ アクセスが許可される
- ✅ ログインページが表示される

#### **2-2. 許可されていないIPアドレスからのアクセス**

**前提条件:**
- 環境変数 `OPS_ALLOWED_IPS` に含まれないIPアドレス
- 例: 自分のIP: 203.0.113.50、許可IP: 192.168.1.100のみ

**操作手順:**
1. 許可されていないIPアドレスからOPSドメインにアクセス

**期待結果:**
- ✅ アクセスが拒否される
- ✅ HTTPステータス 403（Forbidden）が返される
- ✅ エラーメッセージ「Access Denied: IP not allowed」が表示される

#### **2-3. IP制限が設定されていない場合（開発環境）**

**前提条件:**
- 環境変数 `OPS_ALLOWED_IPS` が未設定または空

**操作手順:**
1. 任意のIPアドレスからOPSドメインにアクセス

**期待結果:**
- ✅ アクセスが許可される（IP制限なし）
- ✅ 開発環境用の警告ログが出力される（本番では設定必須）

---

### **3. 全組織一覧表示**

#### **3-1. すべての組織を一覧表示**

**前提条件:**
- テストアカウント: `ops@example.com` / `test1234`
- OPSドメインにログイン済み
- データベースに複数の組織が存在（例: Owner Organization, Admin Organization, Member Organization）

**操作手順:**
1. OPSダッシュボードから「組織管理」ページに移動

**期待結果:**
- ✅ すべての組織が一覧表示される
- ✅ 各組織の以下の情報が表示される：
  - 組織名
  - スラッグ
  - プラン（Free / Pro / Enterprise）
  - メンバー数
  - 作成日
- ✅ 組織名またはスラッグで検索できる
- ✅ 各組織の「詳細」ボタンが表示される

#### **3-2. 組織の詳細表示**

**前提条件:**
- テストアカウント: `ops@example.com` / `test1234`
- 組織一覧ページにアクセス済み

**操作手順:**
1. 組織一覧から「Owner Organization」の「詳細」ボタンをクリック

**期待結果:**
- ✅ 組織詳細ページが表示される
- ✅ 以下の情報が表示される：
  - 組織名、スラッグ
  - プラン、作成日、更新日
  - メンバー一覧（名前、メールアドレス、権限）
  - サブスクリプション状況
  - 使用量統計
- ✅ 「編集」ボタンが表示される（Phase 2）

---

### **4. 全ユーザー一覧表示**

#### **4-1. すべてのユーザーを一覧表示**

**前提条件:**
- テストアカウント: `ops@example.com` / `test1234`
- OPSドメインにログイン済み
- データベースに複数のユーザーが存在

**操作手順:**
1. OPSダッシュボードから「ユーザー管理」ページに移動

**期待結果:**
- ✅ すべてのユーザーが一覧表示される
- ✅ 各ユーザーの以下の情報が表示される：
  - 名前
  - メールアドレス
  - 所属組織（複数の場合はカンマ区切り）
  - 権限（OPS / owner / admin / member）
  - 作成日
- ✅ メールアドレスまたは名前で検索できる
- ✅ 各ユーザーの「詳細」ボタンが表示される

#### **4-2. ユーザーの詳細表示**

**前提条件:**
- テストアカウント: `ops@example.com` / `test1234`
- ユーザー一覧ページにアクセス済み

**操作手順:**
1. ユーザー一覧から「owner@example.com」の「詳細」ボタンをクリック

**期待結果:**
- ✅ ユーザー詳細ページが表示される
- ✅ 以下の情報が表示される：
  - 名前、メールアドレス
  - 所属組織一覧（組織名、権限）
  - OPS権限の有無
  - アカウント作成日、最終ログイン日
  - メール確認状況
- ✅ 「編集」ボタンが表示される（Phase 2）

---

### **5. システム統計情報（Phase 2）**

#### **5-1. ダッシュボードで統計情報を表示**

**前提条件:**
- テストアカウント: `ops@example.com` / `test1234`
- OPSドメインにログイン済み

**操作手順:**
1. OPSダッシュボード（`ops.local.test:3000`）にアクセス

**期待結果:**
- ✅ 以下の統計情報が表示される：
  - 総組織数
  - 総ユーザー数
  - プラン別組織数（Free / Pro / Enterprise）
  - 今月の新規登録組織数
  - 今月の新規登録ユーザー数
- ✅ グラフやチャートで可視化される
- ✅ データは自動更新される

---

### **6. システムログ閲覧（Phase 2）**

#### **6-1. システムログの表示**

**前提条件:**
- テストアカウント: `ops@example.com` / `test1234`
- OPSドメインにログイン済み

**操作手順:**
1. OPSダッシュボードから「システムログ」ページに移動

**期待結果:**
- ✅ システムログが時系列で表示される
- ✅ 各ログに以下の情報が含まれる：
  - ログレベル（INFO / WARN / ERROR）
  - メッセージ
  - タイムスタンプ
  - 関連ユーザー/組織
- ✅ ログレベルでフィルタリングできる
- ✅ エラーログのみ表示するオプションがある

---

## 👤 使用するテストアカウント

| メールアドレス | パスワード | 権限 | 組織 | 用途 |
|--------------|----------|------|------|------|
| `ops@example.com` | `test1234` | OPS | なし | OPS権限のテスト |
| `owner@example.com` | `test1234` | owner | Owner Organization | 権限不足のエラーケース |
| `admin@example.com` | `test1234` | admin | Admin Organization | 権限不足のエラーケース |
| `member@example.com` | `test1234` | member | Member Organization | 権限不足のエラーケース |

## ⏰ 実装優先度

### **Phase 1: MVP（最優先）**

1. ✅ **OPS専用ログイン** - `ops.local.test:3000/login` での認証
2. ✅ **IP制限チェック** - 許可IPアドレスのみアクセス可能
3. ✅ **全組織一覧表示** - システム内のすべての組織を表示
4. ✅ **全ユーザー一覧表示** - システム内のすべてのユーザーを表示

### **Phase 2: 機能拡張**

5. ⏳ **組織詳細の確認・編集** - 個別組織の詳細情報と編集
6. ⏳ **ユーザー詳細の確認・編集** - 個別ユーザーの詳細情報と編集
7. ⏳ **システム統計情報** - ダッシュボードに統計情報を表示
8. ⏳ **システムログ閲覧** - エラーログ、監査ログの確認

### **Phase 3: 高度な管理機能**

9. ⏳ **組織の強制削除** - 任意の組織を削除
10. ⏳ **ユーザーの強制削除** - 任意のユーザーを削除
11. ⏳ **プラン強制変更** - 任意の組織のプランを変更
12. ⏳ **使用量リセット** - 任意の組織の使用量をリセット

---

## 📝 補足事項

### **OPS権限の特徴**

- **独立した権限システム**: 組織に所属せず、システム全体を管理
- **データベース設計**: `profiles.is_ops = true` で判定
- **アクセス制限**: IP制限により、許可されたIPアドレスからのみアクセス可能

### **レイアウト設計**

- **デザイン**: ダークテーマ（黒・赤系）
- **ヘッダー**: 横並びナビゲーション + ユーザーメニュー（組織切り替えなし）
- **ナビゲーション**:
  - ダッシュボード
  - 組織管理
  - ユーザー管理
  - システムログ
  - システム設定

### **IP制限の実装**

#### **環境変数**
```env
OPS_ALLOWED_IPS=192.168.1.100,10.0.0.50,203.0.113.25
```

#### **ミドルウェア（`src/middleware.ts`）**
```typescript
if (domain === DOMAINS.OPS) {
  const allowedIps = process.env.OPS_ALLOWED_IPS?.split(',') || []
  const clientIp = request.headers.get('x-forwarded-for')?.split(',')[0] || 'unknown'

  if (allowedIps.length > 0 && !allowedIps.includes(clientIp)) {
    return new NextResponse('Access Denied: IP not allowed', { status: 403 })
  }
}
```

### **セキュリティ注意事項**

- **本番環境では必ずIP制限を設定すること**
- **OPS権限の付与は慎重に行うこと**（システム全体にアクセス可能）
- **OPSログインページは`/login`ではなく`ops.domain.com/login`に配置**（WWWドメインとは完全に分離）

### **エラーハンドリング**

- 未認証ユーザー → OPSログインページにリダイレクト
- OPS権限なし → エラーメッセージ + WWWログインページにリダイレクト
- IP制限違反 → 403エラー + アクセス拒否メッセージ

---

作成日: 2025-10-18
Next.js 15 + TypeScript + Supabase + マルチテナント
