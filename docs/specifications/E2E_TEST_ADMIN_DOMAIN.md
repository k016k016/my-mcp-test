# ADMINドメイン E2Eテスト仕様書

最終更新: 2025-10-18

## 📋 概要

ADMINドメイン（`admin.local.test:3000`）は**組織管理者（owner/admin権限）向けの管理ダッシュボード**です。組織の設定、メンバー管理、サブスクリプション管理、監査ログなどの管理機能を提供します。

## 🎯 テスト対象機能

### Phase 1: MVP（最小限の実装）

| 機能 | 説明 | 優先度 |
|------|------|--------|
| **組織情報の編集** | 組織名、スラッグ、設定の変更 | 🔴 高 |
| **メンバー管理** | メンバー一覧表示、招待、削除、権限変更 | 🔴 高 |
| **プロフィール設定** | 管理者自身のプロフィール編集 | 🔴 高 |

### Phase 2: 機能拡張（MVP後）

| 機能 | 説明 | 優先度 |
|------|------|--------|
| **サブスクリプション管理** | プラン変更、支払い情報更新、使用量確認 | 🟡 中 |
| **使用量モニタリング** | 組織の使用量・制限の確認 | 🟡 中 |
| **監査ログ閲覧** | 組織内のアクション履歴確認 | 🟢 低 |

## 🧪 テストケース

---

### **1. 組織情報の編集**

#### **1-1. owner権限ユーザーの組織情報編集**

**前提条件:**
- テストアカウント: `owner@example.com` / `test1234`
- 組織: Owner Organization

**操作手順:**
1. WWWドメイン（`www.local.test:3000/login`）でログイン
2. ADMINドメイン（`admin.local.test:3000`）に自動リダイレクト
3. サイドバーから「組織設定」ページに移動
4. 組織名を「Updated Owner Organization」に変更
5. 「保存」ボタンをクリック

**期待結果:**
- ✅ 成功メッセージ「組織情報を更新しました」が表示される
- ✅ ページがリロードされ、新しい組織名が表示される
- ✅ ヘッダーの組織名も更新される

#### **1-2. admin権限ユーザーの組織情報編集**

**前提条件:**
- テストアカウント: `admin@example.com` / `test1234`
- 組織: Admin Organization

**操作手順:**
1. WWWドメインでログイン
2. ADMINドメインに自動リダイレクト
3. 「組織設定」ページで組織名を変更

**期待結果:**
- ✅ admin権限でも組織情報を編集できる
- ✅ 成功メッセージが表示される

#### **1-3. member権限ユーザーがADMINドメインにアクセス**

**前提条件:**
- テストアカウント: `member@example.com` / `test1234`

**操作手順:**
1. WWWドメインでログイン（APPドメインにリダイレクトされる）
2. 直接ADMINドメイン（`admin.local.test:3000`）にアクセス

**期待結果:**
- ✅ エラーメッセージ「管理者権限がありません」が表示される
- ✅ APPドメインにリダイレクトされる

---

### **2. メンバー管理**

#### **2-1. メンバー一覧の表示**

**前提条件:**
- テストアカウント: `owner@example.com` / `test1234`
- ADMINドメインにログイン済み

**操作手順:**
1. サイドバーから「メンバー管理」ページに移動

**期待結果:**
- ✅ メンバー一覧が表形式で表示される
- ✅ 各メンバーの以下の情報が表示される：
  - 名前
  - メールアドレス
  - 権限（owner / admin / member）
  - 招待日時
- ✅ owner権限のメンバーには「オーナー」バッジ（👑王冠）が表示される
- ✅ 「メンバーを招待」ボタンが表示される

#### **2-2. メンバーの招待（ローカル環境）**

**前提条件:**
- テストアカウント: `owner@example.com` / `test1234`
- メンバー管理ページにアクセス済み
- 環境: ローカル開発環境

**操作手順:**
1. 「メンバーを招待」ボタンをクリック
2. 招待フォームが表示される
3. メールアドレス「newmember@example.com」を入力
4. 権限「member」を選択
5. 「招待」ボタンをクリック

**期待結果:**
- ✅ 成功メッセージ「メンバーを招待しました」が表示される
- ✅ **ローカル環境のため、以下の情報が表示される：**
  - メールアドレス: `newmember@example.com`
  - パスワード: `password123`（固定）
- ✅ メンバー一覧に新しいメンバーが追加される
- ✅ 新しいメンバーの権限は「member」

#### **2-3. メンバーの招待（Vercel環境）**

**前提条件:**
- テストアカウント: `owner@example.com` / `test1234`
- 環境: Vercel（プレビューまたは本番）

**操作手順:**
1. 「メンバーを招待」ボタンをクリック
2. メールアドレス「newmember@example.com」を入力
3. 権限「admin」を選択
4. 「招待」ボタンをクリック

**期待結果:**
- ✅ 成功メッセージ「招待メールを送信しました」が表示される
- ✅ **Vercel環境のため、メールが送信される**
- ✅ ユーザーは招待メールからパスワードを設定
- ✅ メンバー一覧に「招待中」ステータスで表示される

#### **2-4. メンバーの権限変更**

**前提条件:**
- テストアカウント: `owner@example.com` / `test1234`
- メンバー管理ページにアクセス済み
- 既存メンバー「member@example.com」が存在

**操作手順:**
1. メンバー一覧から「member@example.com」を選択
2. 権限を「member」から「admin」に変更
3. 「保存」ボタンをクリック

**期待結果:**
- ✅ 成功メッセージ「権限を変更しました」が表示される
- ✅ メンバー一覧で権限が「admin」に更新される
- ✅ 該当ユーザーがログインし直すと、ADMINドメインにアクセスできる

#### **2-5. メンバーの削除**

**前提条件:**
- テストアカウント: `owner@example.com` / `test1234`
- メンバー管理ページにアクセス済み
- 削除対象メンバー「newmember@example.com」が存在

**操作手順:**
1. メンバー一覧から「newmember@example.com」を選択
2. 「削除」ボタンをクリック
3. 確認ダイアログで「削除」を確認

**期待結果:**
- ✅ 成功メッセージ「メンバーを削除しました」が表示される
- ✅ メンバー一覧から該当メンバーが削除される
- ✅ 削除されたユーザーはログインしても、この組織にアクセスできない

#### **2-6. owner権限を削除しようとする**

**前提条件:**
- テストアカウント: `owner@example.com` / `test1234`
- メンバー管理ページにアクセス済み

**操作手順:**
1. メンバー一覧から自分自身（owner）を選択
2. 「削除」ボタンをクリック

**期待結果:**
- ✅ エラーメッセージ「オーナーは削除できません」が表示される
- ✅ または、削除ボタンが無効化されている

---

### **3. プロフィール設定**

#### **3-1. 管理者のプロフィール編集**

**前提条件:**
- テストアカウント: `owner@example.com` / `test1234`
- ADMINドメインにログイン済み

**操作手順:**
1. ヘッダーのユーザーメニューから「プロフィール設定」を選択
2. 名前を「Updated Owner」に変更
3. 「保存」ボタンをクリック

**期待結果:**
- ✅ 成功メッセージ「プロフィールを更新しました」が表示される
- ✅ ヘッダーのユーザー名が「Updated Owner」に更新される

---

### **4. サブスクリプション管理（Phase 2）**

#### **4-1. 現在のプラン確認**

**前提条件:**
- テストアカウント: `owner@example.com` / `test1234`
- ADMINドメインにログイン済み

**操作手順:**
1. サイドバーから「サブスクリプション」ページに移動

**期待結果:**
- ✅ 現在のプラン（Free / Pro / Enterprise）が表示される
- ✅ プランの詳細（料金、制限）が表示される
- ✅ 「プランを変更」ボタンが表示される

#### **4-2. プラン変更**

**前提条件:**
- テストアカウント: `owner@example.com` / `test1234`
- サブスクリプションページにアクセス済み
- 現在のプラン: Free

**操作手順:**
1. 「プランを変更」ボタンをクリック
2. プラン選択画面で「Pro」プランを選択
3. 支払い情報を入力（モック環境）
4. 「確定」ボタンをクリック

**期待結果:**
- ✅ 成功メッセージ「プランを変更しました」が表示される
- ✅ 現在のプランが「Pro」に更新される
- ✅ 組織の使用量制限が更新される

#### **4-3. admin権限でのサブスクリプション管理制限**

**前提条件:**
- テストアカウント: `admin@example.com` / `test1234`
- ADMINドメインにログイン済み

**操作手順:**
1. サイドバーから「サブスクリプション」ページに移動
2. 「プランを変更」ボタンをクリック

**期待結果:**
- ✅ エラーメッセージ「サブスクリプション管理はオーナーのみ実行できます」が表示される
- ✅ または、プラン変更ボタンが無効化されている
- ✅ プランの閲覧は可能

---

### **5. 使用量モニタリング（Phase 2）**

#### **5-1. 組織の使用量確認**

**前提条件:**
- テストアカウント: `owner@example.com` / `test1234`
- ADMINドメインにログイン済み

**操作手順:**
1. サイドバーから「使用量」ページに移動

**期待結果:**
- ✅ 現在の使用量が表示される（例: ストレージ、API呼び出し数）
- ✅ プランの制限が表示される
- ✅ 使用率がプログレスバーで可視化される
- ✅ 制限超過の場合は警告メッセージが表示される

---

### **6. 監査ログ閲覧（Phase 2）**

#### **6-1. 監査ログの表示**

**前提条件:**
- テストアカウント: `owner@example.com` / `test1234`
- ADMINドメインにログイン済み

**操作手順:**
1. サイドバーから「監査ログ」ページに移動

**期待結果:**
- ✅ 監査ログが時系列で表示される
- ✅ 各ログに以下の情報が含まれる：
  - アクション（例: メンバー招待、組織設定変更）
  - 実行者
  - 日時
  - IPアドレス
- ✅ ログのフィルタリング機能が使用できる

---

## 👤 使用するテストアカウント

| メールアドレス | パスワード | 権限 | 組織 | 用途 |
|--------------|----------|------|------|------|
| `owner@example.com` | `test1234` | owner | Owner Organization | オーナー権限のテスト |
| `admin@example.com` | `test1234` | admin | Admin Organization | 管理者権限のテスト |
| `member@example.com` | `test1234` | member | Member Organization | 権限不足のエラーケース |

## ⏰ 実装優先度

### **Phase 1: MVP（最優先）**

1. ✅ **組織情報の編集** - 組織名、スラッグ、設定変更
2. ✅ **メンバー管理** - 一覧、招待、削除、権限変更
3. ✅ **プロフィール設定** - 管理者自身のプロフィール編集

### **Phase 2: 機能拡張**

4. ⏳ **サブスクリプション管理** - プラン変更、支払い情報更新
5. ⏳ **使用量モニタリング** - 使用量・制限の可視化
6. ⏳ **監査ログ閲覧** - アクション履歴の確認

### **Phase 3: 利便性向上**

7. ⏳ **高度なフィルタリング** - メンバー、ログの検索・フィルタ
8. ⏳ **CSV/PDFエクスポート** - データのエクスポート機能

---

## 📝 補足事項

### **権限の階層**

- **owner（オーナー）**: すべての管理機能にアクセス可能（サブスクリプション管理含む）
- **admin（管理者）**: メンバー管理、組織設定は可能。サブスクリプション管理は不可
- **member（一般メンバー）**: ADMINドメインにアクセス不可

### **レイアウト設計**

- **デザイン**: サイドバー + メインコンテンツ（紫系アクセント）
- **サイドバー**:
  - ダッシュボード
  - 組織設定
  - メンバー管理
  - サブスクリプション
  - 使用量
  - 監査ログ
- **ヘッダー**: 組織切り替え（複数組織の場合） + ユーザーメニュー

### **環境別の挙動**

#### **ローカル環境**
- メンバー招待時、メール送信なし
- パスワード固定（`password123`）
- 認証情報をUIに表示

#### **Vercel環境（プレビュー・本番）**
- メンバー招待時、招待メール送信
- ユーザーが自分でパスワード設定
- 招待URLを使用

### **エラーハンドリング**

- member権限でADMINアクセス → エラーメッセージ + APPリダイレクト
- admin権限でサブスクリプション管理 → エラーメッセージ（owner専用）
- owner削除試行 → エラーメッセージ（オーナーは削除不可）

---

作成日: 2025-10-18
Next.js 15 + TypeScript + Supabase + マルチテナント
