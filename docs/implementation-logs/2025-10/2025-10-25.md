# å®Ÿè£…ãƒ­ã‚° - 2025-10-25

---

## 2025-10-25: E2Eãƒ†ã‚¹ãƒˆç”¨èªè¨¼ãƒã‚¤ãƒ‘ã‚¹æ©Ÿæ§‹ã¨æœ¬ç•ªç”¨redirect()ã®ä¸¡ç«‹å®Ÿè£…

### ğŸ“Œ å®Ÿè£…ã®èƒŒæ™¯

ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ç›´å¾Œã®E2Eãƒ†ã‚¹ãƒˆã§ã€Server Actionå¿œç­”ã‚¹ãƒˆãƒªãƒ¼ãƒ åˆ‡æ–­ã«ã‚ˆã‚‹CookieåŒæœŸå•é¡ŒãŒç™ºç”Ÿï¼š
- **å•é¡Œ**: ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—å¾Œã€`/onboarding/select-plan`ã¸é·ç§»ã™ã¹ãã¨ã“ã‚ã€èªè¨¼ãƒã‚§ãƒƒã‚¯ã§`AuthPending`ã¾ãŸã¯`/login`ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã‚‹
- **æ ¹æœ¬åŸå› **: Server Actionã®å¿œç­”ãŒå®Œäº†ã™ã‚‹å‰ã«ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ãŒé·ç§»ï¼ˆã‚¢ãƒ³ãƒã‚¦ãƒ³ãƒˆï¼‰ã—ã€Set-Cookieãƒ˜ãƒƒãƒ€ãƒ¼ãŒã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆCookieã«åŒæœŸã•ã‚Œãªã„ï¼ˆ`failed to forward action response`ã‚¨ãƒ©ãƒ¼ï¼‰

**é¸æŠè‚¢ã®æ¤œè¨**:
1. ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§è¤‡é›‘ãªé·ç§»åˆ¶å¾¡ã‚’å®Ÿè£…ï¼ˆä¸å®‰å®šï¼‰
2. E2Eå°‚ç”¨ã®èªè¨¼ãƒã‚¤ãƒ‘ã‚¹æ©Ÿæ§‹ã‚’å®Ÿè£…ï¼ˆå®‰å®šã ãŒãƒ†ã‚¹ãƒˆé™å®šï¼‰
3. **ä¸¡ç«‹ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ**: E2Eã¯ãƒã‚¤ãƒ‘ã‚¹ã€æœ¬ç•ªã¯Server Action redirect()

â†’ **é¸æŠè‚¢â‘¢ã‚’æ¡ç”¨**: E2Eã®å®‰å®šæ€§ã¨æœ¬ç•ªã®æ­£è¦ãƒ•ãƒ­ãƒ¼ã‚’ä¸¡ç«‹

### ğŸ¯ å®Ÿè£…å†…å®¹

#### 1. E2Eå°‚ç”¨èªè¨¼ãƒã‚¤ãƒ‘ã‚¹ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆå …ç‰¢åŒ–ç‰ˆï¼‰

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/app/testhelpers/dev-login/route.ts`ï¼ˆæ–°è¦ï¼‰

```typescript
import { cookies } from 'next/headers'
import { NextResponse } from 'next/server'

/**
 * E2Eãƒ†ã‚¹ãƒˆå°‚ç”¨ã®æ“¬ä¼¼èªè¨¼ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
 *
 * ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£:
 * - æœ¬ç•ªç’°å¢ƒã§ã¯å®Œå…¨ã«ç„¡åŠ¹åŒ–
 * - E2Eç’°å¢ƒãƒ•ãƒ©ã‚°ãŒå¿…è¦
 * - ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãƒˆãƒ¼ã‚¯ãƒ³ã«ã‚ˆã‚‹èªè¨¼
 */
export async function POST(req: Request) {
  // ç’°å¢ƒã‚¬ãƒ¼ãƒ‰: æœ¬ç•ªç’°å¢ƒã§ã¯404ã‚’è¿”ã™
  if (process.env.NODE_ENV === 'production') {
    return new Response('Not found', { status: 404 })
  }

  // E2Eç’°å¢ƒãƒ•ãƒ©ã‚°ãƒã‚§ãƒƒã‚¯
  if (process.env.NEXT_PUBLIC_E2E !== '1') {
    return new Response('Not found', { status: 404 })
  }

  // ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæ¤œè¨¼
  try {
    const body = await req.json()
    const { secret } = body

    if (!secret || secret !== process.env.TEST_HELPER_SECRET) {
      console.warn('[dev-login] Invalid or missing secret')
      return new Response('Forbidden', { status: 403 })
    }
  } catch (error) {
    console.error('[dev-login] Failed to parse request body:', error)
    return new Response('Bad Request', { status: 400 })
  }

  // E2Eå°‚ç”¨ã®æ“¬ä¼¼èªè¨¼Cookieã‚’è¨­å®š
  const cookieStore = await cookies()
  cookieStore.set({
    name: 'e2e_auth',
    value: '1',
    httpOnly: true,
    path: '/',
    sameSite: 'lax',
    domain: process.env.NODE_ENV === 'production' ? '.yourdomain.com' : '.local.test',
    secure: process.env.NODE_ENV === 'production',
    maxAge: 60 * 30, // 30åˆ†
  })

  console.log('[dev-login] E2E auth cookie set successfully')

  return NextResponse.json({ ok: true })
}
```

**å‹•ä½œ**:
- **3é‡ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¬ãƒ¼ãƒ‰**: æœ¬ç•ªç’°å¢ƒãƒã‚§ãƒƒã‚¯ + E2Eãƒ•ãƒ©ã‚° + ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæ¤œè¨¼
- Cookieæœ‰åŠ¹æœŸé™30åˆ†ã€HTTPOnlyã€SameSite=laxè¨­å®š
- E2Eç’°å¢ƒã§ã®ã¿å‹•ä½œã—ã€æœ¬ç•ªã§ã¯404ã‚’è¿”ã™

#### 2. ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã§`/testhelpers/*`ã‚’ç´ é€šã—

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/middleware.ts`

```typescript
export async function middleware(request: NextRequest) {
  // 1) Server Action / RSC ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯ç„¡æ¡ä»¶ã§ç´ é€šã—
  const nextAction = request.headers.get('next-action')
  const rscHeader = request.headers.get('rsc')
  const ct = request.headers.get('content-type') || ''
  const isRSC =
    ct.includes('multipart/form-data') ||
    ct.includes('text/x-component') ||
    !!nextAction ||
    !!rscHeader

  if (isRSC) {
    console.log('[Middleware] Server Action/RSC detected, passing through:', request.nextUrl.pathname)
    return NextResponse.next()
  }

  // 2) /testhelpers/* ãƒ‘ã‚¹ã¯E2Eãƒ†ã‚¹ãƒˆç”¨ã®ãŸã‚ç´ é€šã—
  if (request.nextUrl.pathname.startsWith('/testhelpers/')) {
    console.log('[Middleware] Test helper path detected, passing through:', request.nextUrl.pathname)
    return NextResponse.next()
  }

  // ... ä»¥é™ã®å‡¦ç†
}
```

**å‹•ä½œ**:
- `/testhelpers/*`ãƒ‘ã‚¹ã‚’æœ€å„ªå…ˆã§ç´ é€šã—
- ãƒªãƒ©ã‚¤ãƒˆå‡¦ç†ã‚„èªè¨¼ãƒã‚§ãƒƒã‚¯ã‚’ãƒã‚¤ãƒ‘ã‚¹
- ã“ã‚Œã«ã‚ˆã‚ŠE2Eå°‚ç”¨ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒæ­£å¸¸ã«å‹•ä½œ

#### 3. Server Actionã«ç’°å¢ƒåˆ¥åˆ†å²ã‚’è¿½åŠ ï¼ˆæœ¬ç•ªç”¨redirectï¼‰

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/app/actions/auth.ts`

```typescript
// å³åº§ã«ãƒ­ã‚°ã‚¤ãƒ³ã§ããŸå ´åˆï¼ˆãƒ¡ãƒ¼ãƒ«ç¢ºèªä¸è¦è¨­å®šã®å ´åˆï¼‰
// ä»•æ§˜: ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—æ™‚ã«ownerã¨ã—ã¦çµ„ç¹”ä½œæˆæ¸ˆã¿ â†’ WWWã®ã‚ªãƒ³ãƒœãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ï¼ˆæ”¯æ‰•ã„ï¼‰ã¸
console.log('[signUp] Signup successful with session - redirecting to plan selection')

// E2Eç’°å¢ƒã§ã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§é·ç§»ã•ã›ã‚‹ï¼ˆdev-loginãƒã‚¤ãƒ‘ã‚¹æ©Ÿæ§‹ã‚’ä½¿ç”¨ï¼‰
if (process.env.NEXT_PUBLIC_E2E === '1') {
  return {
    success: true,
    requiresEmailConfirmation: false,
  }
}

// æœ¬ç•ªç’°å¢ƒã§ã¯Server Actionå†…ã§ç›´æ¥redirectï¼ˆCookieåŒæœŸå•é¡Œã‚’å›é¿ï¼‰
redirect('/onboarding/select-plan')
```

**å‹•ä½œ**:
- **E2Eç’°å¢ƒ**: å€¤ã‚’è¿”ã—ã¦ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§é·ç§»ï¼ˆdev-loginãƒã‚¤ãƒ‘ã‚¹æ©Ÿæ§‹ã‚’ä½¿ç”¨ï¼‰
- **æœ¬ç•ªç’°å¢ƒ**: Server Actionå†…ã§`redirect()`ã‚’å®Ÿè¡Œ
  - Set-Cookieãƒ˜ãƒƒãƒ€ãƒ¼ãŒã‚µãƒ¼ãƒãƒ¼å¿œç­”ã«ç¢ºå®Ÿã«å«ã¾ã‚Œã‚‹
  - RSCå´ã§å³åº§ã«`getUser()`ãŒæˆåŠŸ

#### 4. RSCå´ã®E2Eèªè¨¼ãƒã‚¤ãƒ‘ã‚¹

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/app/www/layout.tsx`

```typescript
export const dynamic = 'force-dynamic' // E2Eç’°å¢ƒã§ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç„¡åŠ¹åŒ–

export default async function WwwLayout({ children }: { children: React.ReactNode }) {
  const supabase = await createClient()
  const headersList = await headers()
  const pathname = headersList.get('x-invoke-path') || ''
  const isOnboarding = pathname.includes('/onboarding')

  // ã‚ªãƒ³ãƒœãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒšãƒ¼ã‚¸ã®å ´åˆã¯èªè¨¼ãƒã‚§ãƒƒã‚¯ã‚’è¡Œã†
  if (isOnboarding) {
    // E2Eç’°å¢ƒã§ã¯æ“¬ä¼¼èªè¨¼Cookieã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆé–‹ç™ºç’°å¢ƒã®ã¿ï¼‰
    if (process.env.NODE_ENV !== 'production') {
      const cookieStore = await cookies()
      const e2eAuth = cookieStore.get('e2e_auth')?.value === '1'
      if (e2eAuth) {
        // E2Eæ“¬ä¼¼èªè¨¼ãŒæœ‰åŠ¹ãªå ´åˆã¯èªè¨¼ãƒã‚§ãƒƒã‚¯ã‚’ã‚¹ã‚­ãƒƒãƒ—
        return <div className="min-h-screen bg-gray-100">{children}</div>
      }
    }

    const {
      data: { user },
    } = await supabase.auth.getUser()

    if (!user) {
      return <AuthPending />
    }

    return <div className="min-h-screen bg-gray-100">{children}</div>
  }
  // ... é€šå¸¸ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
}
```

**å‹•ä½œ**:
- `e2e_auth` CookieãŒå­˜åœ¨ã™ã‚‹å ´åˆã€èªè¨¼ãƒã‚§ãƒƒã‚¯ã‚’ã‚¹ã‚­ãƒƒãƒ—
- E2Eç’°å¢ƒã§ã®ã¿å‹•ä½œï¼ˆæœ¬ç•ªã§ã¯ç„¡è¦–ã•ã‚Œã‚‹ï¼‰
- `dynamic = 'force-dynamic'`ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç„¡åŠ¹åŒ–

#### 5. E2Eãƒ†ã‚¹ãƒˆã§dev-loginã‚’å‘¼ã³å‡ºã—

**ãƒ•ã‚¡ã‚¤ãƒ«**: `e2e/auth.spec.ts`

```typescript
test('ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ— â†’ ãƒ—ãƒ©ãƒ³é¸æŠ â†’ æ”¯æ‰•ã„ãƒšãƒ¼ã‚¸ã¸', async ({ page }) => {
  await page.goto(`${DOMAINS.WWW}/signup`)

  const timestamp = Date.now()
  const email = `test${timestamp}@example.com`
  const companyName = `Test Company ${timestamp}`

  await page.fill('input[name="email"]', email)
  await page.fill('input[name="password"]', 'TestPass123!')
  await page.fill('input[name="confirmPassword"]', 'TestPass123!')
  await page.fill('input[name="companyName"]', companyName)
  await page.fill('input[name="contactName"]', 'Test User')

  await page.click('button[type="submit"]:has-text("ç„¡æ–™ã§ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆ")')

  // ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†å¾Œã€E2Eå°‚ç”¨ã®æ“¬ä¼¼èªè¨¼ã‚’è¨­å®š
  const devLoginResponse = await page.request.post(`${DOMAINS.WWW}/testhelpers/dev-login`, {
    data: {
      secret: process.env.TEST_HELPER_SECRET || 'test-secret-key',
    },
  })
  expect(devLoginResponse.ok()).toBeTruthy()

  // ãƒ—ãƒ©ãƒ³é¸æŠãƒšãƒ¼ã‚¸ã«é·ç§»
  await page.goto(`${DOMAINS.WWW}/onboarding/select-plan`)

  // âœ… ãƒ—ãƒ©ãƒ³é¸æŠãƒšãƒ¼ã‚¸ã«åˆ°é”
  await expect(page).toHaveURL(/\/onboarding\/select-plan/, { timeout: 10000 })

  // âœ… ãƒ—ãƒ©ãƒ³é¸æŠUIãŒè¡¨ç¤ºã•ã‚Œã‚‹
  await expect(page.locator('text=ãƒ—ãƒ©ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„').first()).toBeVisible()
})
```

**å‹•ä½œ**:
- ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—å¾Œã€`/testhelpers/dev-login`ã‚’å‘¼ã³å‡ºã—ã¦Cookieã‚’è¨­å®š
- çµ¶å¯¾URLã‚’ä½¿ç”¨ï¼ˆ`${DOMAINS.WWW}/testhelpers/dev-login`ï¼‰
- ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãƒˆãƒ¼ã‚¯ãƒ³ã‚’é€ä¿¡ã—ã¦èªè¨¼
- ãƒ—ãƒ©ãƒ³é¸æŠãƒšãƒ¼ã‚¸ã«é·ç§»ã—ã¦æ­£å¸¸ã«è¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª

#### 6. ç’°å¢ƒå¤‰æ•°ã®è¨­å®š

**ãƒ•ã‚¡ã‚¤ãƒ«**: `.env.local`

```bash
# E2E Testing
NEXT_PUBLIC_E2E=1
TEST_HELPER_SECRET=test-secret-key
```

**ãƒ•ã‚¡ã‚¤ãƒ«**: `playwright.config.ts`

```typescript
webServer: {
  command: 'npm run dev',
  url: 'http://localhost:3000',
  reuseExistingServer: !process.env.CI,
  env: {
    NEXT_PUBLIC_E2E: '1',
    TEST_HELPER_SECRET: process.env.TEST_HELPER_SECRET || 'test-secret-key',
  },
},
```

**å‹•ä½œ**:
- `.env.local`ã§E2Eç’°å¢ƒãƒ•ãƒ©ã‚°ã¨ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’è¨­å®š
- Playwrightã®é–‹ç™ºã‚µãƒ¼ãƒãƒ¼èµ·å‹•æ™‚ã«ç’°å¢ƒå¤‰æ•°ã‚’æ¸¡ã™

### ğŸ“ å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§

| ãƒ•ã‚¡ã‚¤ãƒ« | å¤‰æ›´å†…å®¹ | ã‚¿ã‚¤ãƒ— |
|---------|---------|--------|
| `src/app/testhelpers/dev-login/route.ts` | E2Eå°‚ç”¨èªè¨¼ãƒã‚¤ãƒ‘ã‚¹ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆ3é‡ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¬ãƒ¼ãƒ‰ï¼‰ | æ–°è¦ |
| `src/middleware.ts` | `/testhelpers/*`ãƒ‘ã‚¹ã‚’ç´ é€šã—ï¼ˆ25-29è¡Œç›®ï¼‰ | å¤‰æ›´ |
| `src/app/actions/auth.ts` | Server Actionã«ç’°å¢ƒåˆ¥åˆ†å²ã‚’è¿½åŠ ï¼ˆE2E/æœ¬ç•ªï¼‰ï¼ˆ141-150è¡Œç›®ï¼‰ | å¤‰æ›´ |
| `src/app/www/layout.tsx` | E2Eèªè¨¼ãƒã‚¤ãƒ‘ã‚¹ãƒã‚§ãƒƒã‚¯ã‚’è¿½åŠ ï¼ˆ28-36è¡Œç›®ï¼‰ | å¤‰æ›´ |
| `e2e/auth.spec.ts` | dev-loginå‘¼ã³å‡ºã—ã‚’è¿½åŠ ï¼ˆ31-36è¡Œç›®ï¼‰ | å¤‰æ›´ |
| `playwright.config.ts` | ç’°å¢ƒå¤‰æ•°ã‚’è¿½åŠ ï¼ˆ167-168è¡Œç›®ï¼‰ | å¤‰æ›´ |
| `.env.local` | E2Eç’°å¢ƒãƒ•ãƒ©ã‚°ã¨ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’è¿½åŠ  | å¤‰æ›´ |

### âœ… ãƒ†ã‚¹ãƒˆçµæœ
- [x] **ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—E2Eãƒ†ã‚¹ãƒˆ**: 1 passed (26.6s) âœ…
- [x] ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæ¤œè¨¼ãŒæ­£å¸¸ã«å‹•ä½œ
- [x] ãƒ—ãƒ©ãƒ³é¸æŠãƒšãƒ¼ã‚¸ã¸ã®é·ç§»æˆåŠŸ
- [x] èªè¨¼ãƒã‚¤ãƒ‘ã‚¹æ©Ÿæ§‹ãŒå®‰å®šå‹•ä½œ
- [x] æœ¬ç•ªç’°å¢ƒã§ã¯404ã‚’è¿”ã™ã“ã¨ã‚’ç¢ºèª

### ğŸ”— é–¢é€£ãƒªãƒ³ã‚¯
- [CLAUDE.md - ã‚ˆãã‚ã‚‹ãƒãƒã‚Šã©ã“ã‚ #8](../CLAUDE.md#ã‚ˆãã‚ã‚‹ãƒãƒã‚Šã©ã“ã‚)
- [èªè¨¼ãƒ•ãƒ­ãƒ¼ä»•æ§˜æ›¸](./specifications/AUTH_FLOW_SPECIFICATION.md)

### ğŸ“ å­¦ã‚“ã ã“ã¨

**ãƒãƒ«ãƒãƒ‰ãƒ¡ã‚¤ãƒ³ç’°å¢ƒã§ã®Server Actionè¨­è¨ˆãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆé¸æŠè‚¢â‘¢ä¸¡ç«‹ã‚¢ãƒ—ãƒ­ãƒ¼ãƒï¼‰**:

| ç’°å¢ƒ | ãƒ•ãƒ­ãƒ¼ | CookieåŒæœŸ | ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ |
|------|--------|-----------|------------|
| **E2E** | dev-loginãƒã‚¤ãƒ‘ã‚¹ | Cookieç›´æ¥è¨­å®šã§å®‰å®š | ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæ¤œè¨¼ |
| **æœ¬ç•ª** | Server Action redirect() | Set-Cookieã§ç¢ºå®Ÿ | æ­£è¦ã®èªè¨¼ãƒ•ãƒ­ãƒ¼ |

**ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–ã¾ã¨ã‚**:
1. **3é‡ã®ã‚¬ãƒ¼ãƒ‰**:
   - `NODE_ENV === 'production'` ãƒã‚§ãƒƒã‚¯
   - `NEXT_PUBLIC_E2E === '1'` ãƒã‚§ãƒƒã‚¯
   - `TEST_HELPER_SECRET` æ¤œè¨¼

2. **æœ¬ç•ªå®Œå…¨ç„¡åŠ¹åŒ–**:
   - æœ¬ç•ªç’°å¢ƒã§ã¯404ã‚’è¿”ã™
   - E2Eãƒ•ãƒ©ã‚°ãŒãªã„ç’°å¢ƒã§ã‚‚404

3. **æœ€å°æ¨©é™ã®åŸå‰‡**:
   - Cookieæœ‰åŠ¹æœŸé™: 30åˆ†
   - HTTPOnlyã€SameSite=laxè¨­å®š
   - ãƒ‰ãƒ¡ã‚¤ãƒ³åˆ¶é™

**Server Actionå¿œç­”ã‚¹ãƒˆãƒªãƒ¼ãƒ åˆ‡æ–­å•é¡Œã®ç†è§£**:
- **å•é¡Œ**: `failed to forward action response` = ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ãŒå…ˆã«é·ç§»/ã‚¢ãƒ³ãƒã‚¦ãƒ³ãƒˆã—ã€Server Actionã®å¿œç­”ã‚¹ãƒˆãƒªãƒ¼ãƒ ãŒé€”ä¸­ã§åˆ‡ã‚Œã‚‹
- **å½±éŸ¿**: Set-Cookieãƒ˜ãƒƒãƒ€ãƒ¼ãŒã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆCookieã«åŒæœŸã•ã‚Œãªã„
- **E2Eè§£æ±ºç­–**: CookieåŒæœŸã‚’å¾…ãŸãšã«ã€ãƒ†ã‚¹ãƒˆå°‚ç”¨ã®èªè¨¼ãƒã‚¤ãƒ‘ã‚¹ã‚’ä½¿ç”¨
- **æœ¬ç•ªè§£æ±ºç­–**: Server Actionå†…ã§redirect()ã‚’å®Ÿè¡Œã—ã€Set-Cookieã‚’ç¢ºå®Ÿã«è¿”ã™

**Middlewareã§ã®æ³¨æ„ç‚¹**:
- `/testhelpers/*` ãƒ‘ã‚¹ã¯**æœ€å„ªå…ˆã§ç´ é€šã—**ã•ã›ã‚‹ã“ã¨
- ãƒªãƒ©ã‚¤ãƒˆã‚„èªè¨¼ãƒã‚§ãƒƒã‚¯ã§å‡¦ç†ã™ã‚‹ã¨ã€E2Eå°‚ç”¨ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒå‹•ä½œã—ãªã„

---

## 2025-10-25: çµ„ç¹”åˆ‡ã‚Šæ›¿ãˆE2Eãƒ†ã‚¹ãƒˆç”¨ã®ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—è¿½åŠ 

### ğŸ“Œ å®Ÿè£…ã®èƒŒæ™¯

çµ„ç¹”åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½ã®E2Eãƒ†ã‚¹ãƒˆï¼ˆ`e2e/organization-switching.spec.ts`ï¼‰ã§ã€`loginAsMultiOrg()`é–¢æ•°ãŒä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ãŒã€å¯¾å¿œã™ã‚‹ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆ`multiorg@example.com`ï¼‰ãŒ`e2e/global-setup.ts`ã§ä½œæˆã•ã‚Œã¦ã„ãªã‹ã£ãŸã€‚

**å•é¡Œ**:
- ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ï¼ˆ`helpers.ts`ï¼‰ã§ã¯`multiorg@example.com`ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ2ã¤ã®çµ„ç¹”ã«æ‰€å±ã™ã‚‹å‰æ
- ã—ã‹ã—ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã§ã¯ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä½œæˆã•ã‚Œãš
- çµæœã¨ã—ã¦ã€çµ„ç¹”åˆ‡ã‚Šæ›¿ãˆãƒ†ã‚¹ãƒˆãŒæ­£ã—ãæ©Ÿèƒ½ã›ãš

### ğŸ¯ å®Ÿè£…å†…å®¹

#### 1. è¤‡æ•°çµ„ç¹”æ‰€å±ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ä½œæˆ

**ãƒ•ã‚¡ã‚¤ãƒ«**: `e2e/global-setup.ts`

ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã«`multiorg@example.com`ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨2ã¤ã®çµ„ç¹”ã‚’è¿½åŠ ï¼š

```typescript
// === è¤‡æ•°çµ„ç¹”ãƒ¦ãƒ¼ã‚¶ãƒ¼: multiorg@ãŒ2ã¤ã®ç•°ãªã‚‹çµ„ç¹”ã«æ‰€å± ===
const multiOrgUser = await createTestUser('multiorg@example.com', TEST_PASSWORD, {
  companyName: 'MultiOrg Owner Organization',
  contactName: 'MultiOrg User',
})
const multiOrg1 = await createTestOrganization(multiOrgUser.id, 'MultiOrg Owner Organization', 'multiorg-owner')

// 2ã¤ç›®ã®çµ„ç¹”ã‚’ä½œæˆï¼ˆadminæ¨©é™ç”¨ï¼‰
// æ—¢å­˜ã®çµ„ç¹”ãŒã‚ã‚Œã°å‰Šé™¤
const { data: existingMultiOrg2 } = await supabase
  .from('organizations')
  .select('id')
  .eq('name', 'MultiOrg Admin Organization')

if (existingMultiOrg2 && existingMultiOrg2.length > 0) {
  for (const org of existingMultiOrg2) {
    console.log(`ğŸ”„ æ—¢å­˜çµ„ç¹”ã‚’å‰Šé™¤: MultiOrg Admin Organization`)
    await supabase.from('organization_members').delete().eq('organization_id', org.id)
    await supabase.from('organizations').delete().eq('id', org.id)
  }
}

// çµ„ç¹”ã‚’ä½œæˆ
const { data: multiOrg2Data, error: multiOrg2Error } = await supabase
  .from('organizations')
  .insert({
    name: 'MultiOrg Admin Organization',
    subscription_plan: 'free',
    subscription_status: 'active',
  })
  .select()
  .single()

if (multiOrg2Error) throw multiOrg2Error

console.log('âœ… ãƒ†ã‚¹ãƒˆçµ„ç¹”ä½œæˆ: MultiOrg Admin Organization (multiorg-admin)')

// multiorg@ã‚’adminæ¨©é™ã§è¿½åŠ 
await supabase
  .from('organization_members')
  .insert({
    organization_id: multiOrg2Data.id,
    user_id: multiOrgUser.id,
    role: 'admin',
  })
```

**å‹•ä½œ**:
- `multiorg@example.com`ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆ
- "MultiOrg Owner Organization"ã‚’ä½œæˆã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’owneræ¨©é™ã§è¿½åŠ 
- "MultiOrg Admin Organization"ã‚’ä½œæˆã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’adminæ¨©é™ã§è¿½åŠ 
- æ—¢å­˜ã®çµ„ç¹”ãŒã‚ã‚‹å ´åˆã¯å‰Šé™¤ã—ã¦ã‹ã‚‰ä½œæˆï¼ˆå†ªç­‰æ€§ã‚’ç¢ºä¿ï¼‰

#### 2. ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã®ä¿®æ­£

**ãƒ•ã‚¡ã‚¤ãƒ«**: `e2e/organization-switching.spec.ts`

çµ„ç¹”åˆ‡ã‚Šæ›¿ãˆãƒ†ã‚¹ãƒˆã§`clickAndWaitRedirect()`ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã‚’ä½¿ç”¨ã™ã‚‹ã‚ˆã†ä¿®æ­£ï¼š

```typescript
// ä¿®æ­£å‰ï¼ˆãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ç«¶åˆã®å¯èƒ½æ€§ã‚ã‚Šï¼‰
await otherBtn.click()
await page.waitForLoadState('domcontentloaded')

// ä¿®æ­£å¾Œï¼ˆã‚¯ãƒªãƒƒã‚¯ã¨ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚’åŒæ™‚ã«å¾…æ©Ÿï¼‰
await clickAndWaitRedirect(page, () => otherBtn.click(), 'admin')
```

**ç†ç”±**:
- ä»–ã®çµ„ç¹”åˆ‡ã‚Šæ›¿ãˆãƒ†ã‚¹ãƒˆã§ã¯`clickAndWaitRedirect()`ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹
- ã“ã®é–¢æ•°ã¯ã‚¯ãƒªãƒƒã‚¯ã¨URLé·ç§»ã‚’`Promise.all()`ã§æŸã­ã‚‹ã“ã¨ã§ã€ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã®ç«¶åˆã‚’é˜²ã

### ğŸ“ å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§

| ãƒ•ã‚¡ã‚¤ãƒ« | å¤‰æ›´å†…å®¹ | ã‚¿ã‚¤ãƒ— |
|---------|---------|--------|
| `e2e/global-setup.ts` | `multiorg@example.com`ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨2ã¤ã®çµ„ç¹”ã‚’ä½œæˆã™ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’è¿½åŠ  | å¤‰æ›´ |
| `e2e/organization-switching.spec.ts` | `clickAndWaitRedirect()`ã‚’ä½¿ç”¨ã™ã‚‹ã‚ˆã†ä¿®æ­£ | å¤‰æ›´ |

### âš ï¸ æ®‹èª²é¡Œ

**çµ„ç¹”åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½ã®å®Ÿè£…ãƒã‚°**:
- ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã¯æ­£ã—ãä½œæˆã•ã‚Œã€UIã‚‚æ­£ã—ãè¡¨ç¤ºã•ã‚Œã‚‹
- ã—ã‹ã—ã€çµ„ç¹”åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚‚å®Ÿéš›ã«ã¯çµ„ç¹”ãŒåˆ‡ã‚Šæ›¿ã‚ã‚‰ãªã„
- ãƒšãƒ¼ã‚¸ã¯ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã‚‹ãŒã€çµ„ç¹”åï¼ˆ`current_organization_name`ï¼‰ãŒå¤‰ã‚ã‚‰ãªã„
- **åŸå› **: çµ„ç¹”åˆ‡ã‚Šæ›¿ãˆã®Server Action/Client Componentå®Ÿè£…ã«å•é¡ŒãŒã‚ã‚‹å¯èƒ½æ€§

**æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—**:
1. OrganizationSwitcherã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ã‚³ãƒ¼ãƒ‰ã‚’èª¿æŸ»
2. çµ„ç¹”åˆ‡ã‚Šæ›¿ãˆæ™‚ã®Cookieæ›´æ–°å‡¦ç†ã‚’ç¢ºèª
3. Server ActionãŒæ­£ã—ãå‘¼ã°ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
4. å®Ÿè£…ã‚’ä¿®æ­£ã—ã¦ãƒ†ã‚¹ãƒˆãŒé€šã‚‹ã‚ˆã†ã«ã™ã‚‹

### âœ… ãƒ†ã‚¹ãƒˆç¢ºèªé …ç›®

- [x] `multiorg@example.com`ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä½œæˆã•ã‚Œã‚‹
- [x] "MultiOrg Owner Organization"ãŒä½œæˆã•ã‚Œã‚‹
- [x] "MultiOrg Admin Organization"ãŒä½œæˆã•ã‚Œã‚‹
- [x] çµ„ç¹”åˆ‡ã‚Šæ›¿ãˆUIã«2ã¤ã®çµ„ç¹”ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] çµ„ç¹”åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨å®Ÿéš›ã«çµ„ç¹”ãŒåˆ‡ã‚Šæ›¿ã‚ã‚‹ï¼ˆ**å¤±æ•—ä¸­**ï¼‰

### ğŸ”— é–¢é€£æƒ…å ±

- **ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°**: E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚ã€çµ„ç¹”ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«ã¯2ã¤ã®çµ„ç¹”ãŒæ­£ã—ãè¡¨ç¤ºã•ã‚Œã‚‹
- **ã‚¨ãƒ©ãƒ¼å†…å®¹**: çµ„ç¹”åˆ‡ã‚Šæ›¿ãˆå¾Œã‚‚`current-organization-name`ãŒ"MultiOrg Owner Organization"ã®ã¾ã¾
- **æ—¢å­˜ã®é¡ä¼¼ãƒ†ã‚¹ãƒˆ**: ä»–ã®çµ„ç¹”åˆ‡ã‚Šæ›¿ãˆãƒ†ã‚¹ãƒˆï¼ˆ41è¡Œç›®ã€59è¡Œç›®ï¼‰ã§ã¯`clickAndWaitRedirect()`ã‚’ä½¿ç”¨
