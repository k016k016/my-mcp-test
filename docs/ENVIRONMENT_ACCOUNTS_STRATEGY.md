# 環境別アカウント戦略ガイド

各サービスで、開発/ステージング/本番環境を分けるべきか、それとも1つのアカウントで管理できるかを説明します。

## 📊 サービス別の推奨戦略

| サービス | アカウント分離 | 理由 | コスト影響 |
|---------|--------------|------|-----------|
| **Vercel** | ❌ 不要 | 1プロジェクトで3環境管理 | 1アカウントでOK |
| **Supabase** | ✅ 必須 | データベース分離が必須 | 各環境で無料枠利用可 |
| **Cloudflare R2** | ⚠️ 推奨 | バケットのみ分離でOK | 1アカウントでOK |
| **Upstash Redis** | ⚠️ 推奨 | データベースのみ分離 | 各環境で無料枠利用可 |
| **Resend** | ⚠️ 推奨 | APIキーのみ分離 | 1アカウントでOK |
| **Sentry** | ❌ 任意 | プロジェクトのみ分離 | 1アカウントでOK |
| **PostHog** | ❌ 任意 | プロジェクトのみ分離 | 1アカウントでOK |
| **Chargebee** | ✅ 必須 | テスト/本番モード分離 | テストサイトは無料 |

---

## 0. Vercel（ホスティング） - **1アカウント、1プロジェクトでOK**

### 推奨構成
```
1つのVercelアカウント
  └─ 1つのプロジェクト「my-saas」
      ├─ Production環境（mainブランチ）
      ├─ Preview環境（stagingブランチ）
      └─ Development環境（その他のブランチ）
```

### 理由
- **Vercelは1プロジェクトで複数環境を自動管理**
- ブランチごとに自動的に環境が分かれる
- 環境変数も環境ごとに設定可能

### アカウント数
**1つのVercelアカウント**のみ

### 手順
1. https://vercel.com でアカウント作成（GitHubアカウント推奨）
2. GitHubリポジトリをインポート（1回のみ）
3. 環境変数を各環境に設定
   - Production（本番環境）
   - Preview（ステージング環境）
   - Development（開発環境）

### Vercelの自動環境分離

```
mainブランチへのpush → Production環境に自動デプロイ
  ↓
  www.yourdomain.com
  app.yourdomain.com
  admin.yourdomain.com
  ops.yourdomain.com

stagingブランチへのpush → Preview環境に自動デプロイ
  ↓
  staging.yourdomain.com
  app.staging.yourdomain.com
  admin.staging.yourdomain.com
  ops.staging.yourdomain.com

その他のブランチ → 一時的なPreview URL
  ↓
  my-saas-git-feature-abc123.vercel.app
```

### 環境変数の設定

Vercelダッシュボードで：
1. **Settings** → **Environment Variables**
2. 各変数を追加し、適用環境を選択
   - ✅ Production（本番のみ）
   - ✅ Preview（ステージングのみ）
   - ✅ Development（開発のみ）

例：
```
変数名: NEXT_PUBLIC_SUPABASE_URL
値（Production）: https://production-xxx.supabase.co
値（Preview）: https://staging-xxx.supabase.co
値（Development）: https://dev-xxx.supabase.co
```

### コスト
- **Hobby（個人）**: 無料
  - 月100GB帯域幅
  - 無制限のデプロイ
  - 自動HTTPSと証明書
- **Pro**: $20/月〜（チーム・商用利用）

### ポイント
⭐ **Vercelは複数アカウント・プロジェクト不要**
- 1つのプロジェクトですべての環境を管理
- ブランチ戦略で環境を自動分離
- 環境変数で各環境の設定を切り替え

---

## 1. Supabase - **必ず分離が必要**

### 推奨構成
```
開発環境:   新しいプロジェクト「my-saas-dev」
ステージング: 新しいプロジェクト「my-saas-staging」
本番環境:   新しいプロジェクト「my-saas-production」
```

### 理由
- **データベースが完全に分離される**
- テストデータと本番データが混ざらない
- 開発中のマイグレーション失敗が本番に影響しない
- 各環境で独立したバックアップ

### アカウント数
**1つのSupabaseアカウント**で3つのプロジェクトを作成

### 手順
1. https://supabase.com でアカウント作成（1回のみ）
2. ダッシュボードで「New Project」を3回クリック
   - `my-saas-dev`
   - `my-saas-staging`
   - `my-saas-production`

### コスト
- 開発: **Free** プラン（500MB DB、1GB ファイルストレージ）
- ステージング: **Free** または Pro（必要に応じて）
- 本番: **Pro** プラン（月$25〜、推奨）

---

## 2. Cloudflare R2 - **バケットのみ分離**

### 推奨構成
```
1つのCloudflareアカウント
  └─ dev-my-saas-uploads（開発用バケット）
  └─ staging-my-saas-uploads（ステージング用バケット）
  └─ production-my-saas-uploads（本番用バケット）
```

### 理由
- **バケットで分離できる**
- 1つのアカウントで複数バケット管理可能
- APIトークンはバケット単位で発行可能

### アカウント数
**1つのCloudflareアカウント**のみ

### 手順
1. Cloudflareアカウント作成（1回のみ）
2. R2を有効化（1回のみ）
3. バケットを3つ作成
4. 各バケット用のAPIトークンを作成（オプション：1つのトークンで全バケットアクセスも可）

### コスト
- **無料枠**: 月10GB保存、月100万回リクエスト
- 複数バケットでも無料枠を共有
- 超過分のみ課金

---

## 3. Upstash Redis - **データベースのみ分離**

### 推奨構成
```
1つのUpstashアカウント
  └─ dev-my-saas-cache（開発用DB）
  └─ staging-my-saas-cache（ステージング用DB）
  └─ production-my-saas-cache（本番用DB）
```

### 理由
- **データベースで分離できる**
- キャッシュデータは環境ごとに独立すべき
- 1つのアカウントで複数DB管理可能

### アカウント数
**1つのUpstashアカウント**のみ

### 手順
1. Upstashアカウント作成（1回のみ）
2. データベースを3つ作成
3. 各DBのREST URLとTokenを取得

### コスト
- **無料枠**: 各DBごとに10,000コマンド/日
- 3つのDBでそれぞれ無料枠利用可能

---

## 4. Resend - **APIキーのみ分離（推奨）**

### 推奨構成（パターンA）
```
1つのResendアカウント
  └─ 開発用APIキー（権限制限）
  └─ ステージング用APIキー
  └─ 本番用APIキー
```

### 推奨構成（パターンB - より安全）
```
開発:   無料アカウント（制限あり）
本番:   有料アカウント
```

### 理由
- **APIキーで分離できる**
- ドメイン認証は1つで複数環境対応可能
- 開発環境では送信制限があっても問題ない

### アカウント数
**1つのResendアカウント**（または2つ：開発用+本番用）

### 手順（1アカウントの場合）
1. Resendアカウント作成（1回のみ）
2. ドメイン認証（本番ドメインのみ、オプション）
3. APIキーを3つ作成
   - `dev-api-key`（送信制限: 自分のメールのみ）
   - `staging-api-key`
   - `production-api-key`

### コスト
- **無料枠**: 月3,000通
- 開発環境のテストメールも含む
- 超過する場合のみ有料プラン検討

---

## 5. Sentry - **プロジェクトのみ分離**

### 推奨構成
```
1つのSentryアカウント
  └─ 1つのOrganization
      └─ my-saas-dev（プロジェクト）
      └─ my-saas-staging（プロジェクト）
      └─ my-saas-production（プロジェクト）
```

### 理由
- **プロジェクトで完全に分離される**
- エラーが環境ごとに整理される
- 1つのアカウントで複数プロジェクト管理

### アカウント数
**1つのSentryアカウント**のみ

### 手順
1. Sentryアカウント作成（1回のみ）
2. プロジェクトを3つ作成
3. 各プロジェクトのDSNを取得

### コスト
- **無料枠**: 月5,000エラー
- 3つのプロジェクトで共有
- 開発環境は無効化すれば影響なし

---

## 6. PostHog - **プロジェクトのみ分離**

### 推奨構成
```
1つのPostHogアカウント
  └─ Development（プロジェクト）
  └─ Staging（プロジェクト）
  └─ Production（プロジェクト）
```

### 理由
- **プロジェクトで完全に分離される**
- 分析データが環境ごとに管理される
- 1つのアカウントで複数プロジェクト管理

### アカウント数
**1つのPostHogアカウント**のみ

### 手順
1. PostHogアカウント作成（1回のみ）
2. プロジェクトを3つ作成
3. 各プロジェクトのAPI Keyを取得

### コスト
- **無料枠**: 月100万イベント
- 3つのプロジェクトで共有
- 開発環境のイベント数を考慮

---

## 7. Chargebee - **テスト/本番サイト分離が必須**

### 推奨構成
```
1つのChargebeeアカウント
  └─ my-saas-test（テストサイト）- 開発+ステージング共用
  └─ my-saas-live（本番サイト）- 本番環境
```

### 理由
- **テストモードと本番モードは完全に分離**
- テスト決済と実際の決済が混ざらない
- Chargebeeの仕様で2つのサイトが必要

### アカウント数
**1つのChargebeeアカウント**のみ

### 手順
1. Chargebeeアカウント作成（1回のみ）
2. テストサイト作成（最初のサイト）
3. 本番サイト作成（Settings → Create Live Site）
4. 各サイトのAPI Keyを取得

### コスト
- **テストサイト**: 無料
- **本番サイト**: 取引手数料または月額プラン

---

## 📋 実践的なセットアップ順序

### 最小構成（開発環境のみ）

まず開発環境だけセットアップ：

| サービス | 必要な作業 |
|---------|----------|
| Supabase | プロジェクト1つ作成（dev） |
| R2 | バケット1つ作成（dev） |
| Upstash | DB1つ作成（dev） |
| Resend | APIキー1つ作成 |
| Sentry | スキップ（開発では不要） |
| PostHog | プロジェクト1つ作成（オプション） |
| Chargebee | スキップ（決済機能を使わない限り不要） |

**必要なアカウント数: 4つ**（Supabase、Cloudflare、Upstash、Resend）

### 完全構成（3環境すべて）

本番稼働前に準備：

| サービス | アカウント数 | プロジェクト/リソース数 |
|---------|------------|---------------------|
| **Vercel** | 1アカウント | 1プロジェクト（自動で3環境） |
| Supabase | 1アカウント | 3プロジェクト |
| Cloudflare | 1アカウント | 3バケット |
| Upstash | 1アカウント | 3データベース |
| Resend | 1アカウント | 3APIキー |
| Sentry | 1アカウント | 3プロジェクト |
| PostHog | 1アカウント | 3プロジェクト |
| Chargebee | 1アカウント | 2サイト |

**必要なアカウント数: 8つ**（サービスごとに1つ）

---

## 💡 推奨アプローチ

### フェーズ1: 開発環境のみ（今すぐ）

```bash
# 必須サービスのみセットアップ
1. Supabase（1プロジェクト: dev）
2. Cloudflare R2（1バケット: dev）
3. Upstash Redis（1DB: dev）
4. Resend（1APIキー）

# .env.development に設定
npm run env:dev
```

### フェーズ2: ステージング環境（デプロイ前）

```bash
# 各サービスでステージング用リソース追加
1. Supabase（新プロジェクト: staging）
2. R2（新バケット: staging）
3. Upstash（新DB: staging）
4. Resend（新APIキー: staging）
5. Sentry（新プロジェクト: staging）
6. PostHog（新プロジェクト: staging）

# .env.staging に設定
```

### フェーズ3: 本番環境（リリース時）

```bash
# 各サービスで本番用リソース追加
1. Supabase（新プロジェクト: production + Proプラン）
2. R2（新バケット: production）
3. Upstash（新DB: production）
4. Resend（新APIキー + ドメイン認証）
5. Sentry（新プロジェクト: production）
6. PostHog（新プロジェクト: production）
7. Chargebee（本番サイト作成）

# .env.production に設定
```

---

## 🎯 結論: 今すぐ必要なアカウント

### 開発を始めるために最低限必要

**4つのサービスアカウント**のみ：

1. ✅ **Supabase** - 1アカウント（プロジェクト1つ作成）
2. ✅ **Cloudflare** - 1アカウント（バケット1つ作成）
3. ✅ **Upstash** - 1アカウント（DB1つ作成）
4. ✅ **Resend** - 1アカウント（APIキー1つ作成）

その他は後から追加可能！

### 環境を増やすときは

**新しいアカウント作成は不要** - 同じアカウントで新しいプロジェクト/リソースを追加するだけ

---

## 📝 環境変数ファイルの管理

### 開発環境のみの場合

```bash
.env.development  # テンプレート（Git管理）
.env.local        # 実際の値（gitignore）
```

### 3環境すべての場合

```bash
.env.development  # 開発環境のテンプレート（Git管理）
.env.staging      # ステージング環境のテンプレート（Git管理）
.env.production   # 本番環境のテンプレート（Git管理）
.env.local        # ローカルで使用する実際の値（gitignore）
```

---

## ❓ よくある質問

### Q1: 開発環境でテストしたら、本番のデータベースにも影響する？

**A**: いいえ。Supabaseプロジェクトを分けていれば、完全に独立したデータベースです。

### Q2: 3つの環境すべてにお金がかかる？

**A**: いいえ。各サービスの無料枠を活用すれば、開発+ステージングは無料で運用可能。本番環境のみ有料プランを検討。

### Q3: 1つのアカウントで3つの環境を管理できる？

**A**: はい。ほとんどのサービスは1つのアカウントでプロジェクト/リソースを分けて管理できます。

### Q4: 後から環境を追加できる？

**A**: はい。開発環境だけ作って、後からステージング・本番を追加できます。

### Q5: Resendでドメイン認証は環境ごとに必要？

**A**: いいえ。1つのドメイン（yourdomain.com）を認証すれば、すべての環境で使えます。

---

これで各サービスのアカウント戦略が明確になりました！

**今すぐ始めるなら**: まず4つのサービス（Supabase、R2、Upstash、Resend）のアカウントを1つずつ作成し、開発環境用のリソースを作成するだけでOKです。

### Q6: Vercelは環境ごとにアカウントが必要？

**A**: いいえ。**1つのVercelアカウント、1つのプロジェクトで全環境を管理できます**。Vercelは特別で、ブランチごとに自動的に環境が分かれます。

- `main`ブランチ → Production環境
- `staging`ブランチ → Preview環境（ステージング）
- その他のブランチ → 一時的なPreview URL

環境変数もVercelダッシュボードで環境ごとに設定できるため、非常にシンプルです。
