# ADR-001: マルチドメインアーキテクチャの採用

> **注意**: これは実際のプロジェクトで下した判断のサンプルです。新しいプロジェクトでは、参考として残すか削除してください。

**日付**: 2025-01-15
**ステータス**: Accepted
**決定者**: プロジェクトチーム

---

## コンテキスト

B2B SaaSアプリケーションとして、以下の異なる用途のUIを提供する必要がある：

1. マーケティングサイト（公開ページ、認証）
2. メインアプリケーション（ユーザーが日常的に使用）
3. 管理ダッシュボード（組織の設定、メンバー管理）
4. 運用ツール（システム管理者専用）

これらを1つのドメインで提供するか、複数のドメインに分けるかを検討する必要があった。

---

## 検討した選択肢

### 選択肢1: 単一ドメイン + パス分け

**構成**: `https://domain.com/app`, `https://domain.com/admin`, `https://domain.com/ops`

**メリット**:
- シンプルな構成
- Cookie共有が容易
- デプロイが1つで済む

**デメリット**:
- 全てのコードが1つにバンドルされる
- アクセス制限が複雑
- マーケティングサイトとアプリの混在

---

### 選択肢2: 完全に別のアプリケーション

**構成**: 4つの独立したNext.jsアプリケーション

**メリット**:
- 完全な分離
- 独立したデプロイ
- スケーラビリティ

**デメリット**:
- コード重複
- 認証状態の共有が困難
- メンテナンスコストが高い

---

### 選択肢3: マルチドメイン + Next.jsルートグループ（採用）

**構成**:
- `www.domain.com` → `(www)/`
- `app.domain.com` → `(app)/`
- `admin.domain.com` → `(admin)/`
- `ops.domain.com` → `(ops)/`

**メリット**:
- 論理的な分離（ルートグループ）
- Cookie共有が可能（`.domain.com`）
- 1つのコードベース、1つのデプロイ
- ドメインレベルでのアクセス制限が可能

**デメリット**:
- ミドルウェアの設定が複雑
- ローカル開発で`/etc/hosts`の設定が必要
- Server Action実装時に注意が必要（redirect()問題）

---

## 決定内容

**選択肢3: マルチドメイン + Next.jsルートグループ**を採用する。

### 理由

1. **明確な責任分離**: 各ドメインが明確な用途を持つ
2. **セキュリティ**: OPSドメインをIP制限で保護できる
3. **UX**: ユーザーは目的に応じたURLでアクセス
4. **メンテナンス性**: 1つのコードベースで全て管理
5. **コスト**: デプロイは1つ、インフラコストも最小限

---

## 結果

### メリット

- ✅ ドメインでの責任分離が明確
- ✅ Cookie共有により認証状態をシームレスに管理
- ✅ OPSドメインをIP制限で保護
- ✅ マーケティングサイトとアプリの分離

### デメリット

- ❌ ミドルウェアの複雑性
- ❌ ローカル開発のセットアップが必要（`/etc/hosts`）
- ❌ Server Actionでredirect()を使えない

### トレードオフ

- **複雑性 vs 分離**: ミドルウェアは複雑になるが、各ドメインの責任が明確になる
- **開発コスト vs 保守性**: 初期セットアップは手間だが、長期的には保守しやすい

---

## 実装の詳細

### ミドルウェア

```typescript
export async function middleware(request: NextRequest) {
  const host = request.headers.get('host')
  const domainType = getDomainType(host) // www, app, admin, ops

  // ドメインに応じたルートグループにリライト
  return NextResponse.rewrite(new URL(`/${domainType}${pathname}`, request.url))
}
```

### Cookie設定

```typescript
cookies().set({
  name: 'session',
  domain: '.domain.com', // サブドメイン間で共有
  // ...
})
```

---

## 関連資料

- [マルチドメインセットアップ](../../docs/specifications/MULTI_DOMAIN_SETUP.md)
- [マルチドメインパターン](../patterns/multi-domain.md)
- [認証フロー仕様](../../docs/specifications/AUTH_FLOW_SPECIFICATION.md)

---

この決定により、**明確な責任分離とセキュリティを両立したアーキテクチャ**を実現できました。
