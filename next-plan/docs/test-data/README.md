# テストデータ設計

E2Eテストや統合テストは、データの作成・削除・権限変更によって簡単に壊れる。
ここに書いてあることは絶対に守ること。

---

## 組織とロールの前提

- 各組織にはロールがある: `owner`, `admin`, `member`
- `owner` はその組織に必ず1人以上存在することを前提とする
  - `owner` は最上位権限。組織設定・メンバー管理などを含む
- `admin` は日常運用権限（高権限の管理者）。ただし `owner` ほどフルではない
- `member` は一般ユーザ

重要:
- 組織から `owner` がいない状態は不正状態として扱う。  
  → 「テストの中でownerユーザを削除する」「ownerロールを外してしまう」といった操作は禁止。
- テスト中に `member` を `owner` に昇格させる等、ロールの付け替えで無理やり通すやり方は禁止。

これは仕様そのもの。E2Eの便宜のために崩してはいけない。

---

## 固定ユーザ / 固定組織

以下は seed 済み（＝あらかじめDBに投入されている）ことを前提とした、テスト用アカウント・組織の例。  
実際の値はプロジェクト側のseedに合わせて更新すること。

- `test_user_basic@example.com`
  - ロール例: `member`
  - 所属組織: `test_org_alpha`

- `test_user_admin@example.com`
  - ロール例: `admin`
  - 所属組織: `test_org_alpha`

- `test_user_ops@example.com`
  - ロール例: （opsドメイン向けの権限。**orgロールとは別枠**。admin/owner/memberとは混ぜない）
  - 所属組織: `test_org_beta`

- 組織:
  - `test_org_alpha`
    - 必ず `owner` が存在する状態としてseedされていること
  - `test_org_beta`
    - 同様に `owner` が存在すること

これら seed ユーザのロール・所属は仕様であり、勝手に変更しない。

やってはいけない例:
- 「テストのために `test_user_basic@example.com` を owner に昇格させます」
- 「この組織はownerがいなくてもいいことにしましょう」
- 「権限チェックを回避するために一時的に全員adminにしました」

全部禁止。

---

## 既存データを消そうとしないこと

- 既に存在するテストユーザや組織を `DELETE` するE2Eテストは書かない。
- 「テストの前に一旦クリーンアップします」という理由で既存アカウントや組織そのものを削除しようとしない。
- 特に、`owner` を削除して組織を「オーナー不在状態」にするようなテストは禁止。

削除フローの検証が必要な場合は、ユニットテスト（モック）で対応する。E2Eではやらない。

理由:
- 一度でも削除に失敗すると、以降の実行で「そのユーザ/組織がもう存在しない」状態になり、CIやローカルが永久にREDになる。
- 組織の `owner` が消えると本番前提を壊すので、その後の権限系テストが全部意味を失う。

---

## サインアップ系テストだけ例外で「新規ユーザ作成」を許可する

- 「ユーザ登録フローそのもの」をテストしたい場合だけ、E2E内で新しいユーザを作ってよい。
- その場合、メールアドレスは必ずユニークにすること。

  フォーマット:
  - `e2e+<yyyyMMddHHmmss>@example.com`
  - 例: `e2e+20251025T130455@example.com`

ルール:
- 同じメールアドレスを使い回さない。
- 既存ユーザを削除して再利用しようとしない。
- seed済みユーザのロールや所属組織をいじらない代わりに、「新規登録ユーザ」はテスト内だけで使い捨てでOK。

これで「すでに登録済みなのでサインアップできません」でE2Eが恒久的に落ちる事故を防ぐ。

---

## 権限をテスト中に付け替えないこと

- 「E2Eの途中で `member` を `admin` に昇格させて、そのまま管理画面にアクセスさせる」は禁止。
- 「一時的にこのユーザをowner扱いにする」は論外。
- 代わりに：
  - admin権限の挙動をテストしたいなら、最初から `admin` ロールのseedユーザでログインしてシナリオを書く。
  - owner権限が必要な操作なら、ownerロールのseedユーザ（もしくはそれに相当する想定ユーザ）を使う。

理由:
- ロールの昇格はビジネス的に監査対象の操作（監査ログ・承認フローなど）なので、テストの中で適当に付け替えると「本番と違う前提で動いてる偽物のテスト」になる。

---

## DBリセットについて

- E2E内から `TRUNCATE` / `DROP` / migrationのやり直し などでDB全体を初期化する提案は禁止。
- 将来的に `npm run test:e2e` の前処理として、公式スクリプト（例: `scripts/reset-e2e-db.ts`）でテスト用DBを初期状態に戻す想定。
- その公式スクリプトが存在する場合はそれを使う。それ以外のリセット方法を勝手に提案しない。

---

## まとめ（Claudeへの約束）

- seed済みユーザ・seed済み組織を使え。勝手にロールを変更するな。
- 組織からownerを消すな。owner不在の組織をテストで作るな。
- 既存のテストユーザ/組織を削除するE2Eは書くな。
- サインアップ系テストだけ、新規ユーザを一時作成してよい。そのときは必ずユニークな `e2e+timestamp@example.com` を使え。再利用禁止。
- 「テストのために一時的にadmin/owner権限を付与します」は禁止。
- DB全クリアやTRUNCATEなどの力技リセットをテスト側でやろうとするな。公式スクリプト以外は禁止。