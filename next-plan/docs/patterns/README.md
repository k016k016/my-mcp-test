# パターンカタログ

このプロジェクトでは、以下のパターンを標準とする。
「別のやり方のほうがキレイです」「一般的にはこうします」というだけの理由で変更してはならない。
例外が必要な場合は ADR (`docs/decisions/`) を追加してからにすること。

---

## Server Actions

### 役割
- Server Action は DB更新、権限チェック、バリデーションなどサーバ側の処理を担当する。
- Server Action は画面遷移を担当しない。`redirect()` は禁止。

### 戻り値ルール
- Server Action は「結果オブジェクト」を返す。
  - 例:
    ```ts
    { success: true, nextUrl: "/dashboard" }
    { success: false, error: "権限がありません" }
    ```

- `nextUrl` は「クライアントが次に遷移すべき場所」を示すだけであり、Server Actionが直接遷移はしない。

### クライアント側での使い方
- クライアント側は Server Action の戻り値を見て `router.push(result.nextUrl)` などを実行する。
- これが基本パターン。勝手に別のI/Fを提案しないこと。

---

## 権限チェック / RLS

### 原則
- クライアントが送ってきた `orgId`, `userRole`, などをそのまま信じない。
- Server Action 側でもう一度「このユーザはこの組織でこの操作を許されているか」を確認する。

### NGパターン
- 「まずは全件SELECTしてクライアント側で絞る」は禁止。
  - RLS / アクセス制御はDBとサーバ側で完結させる。

### OKパターン
- サーバ側で「このユーザが見ていい行だけ」を取得して返す。
- クライアントには余計な行を返さない。

---

## マルチドメイン

### 前提
- このプロジェクトはマルチドメインで動作する。
  - 例: `app.local.test`, `admin.local.test`, `ops.local.test`
- ドメインごとに役割・権限が分かれる。

### 遷移の考え方
- ドメイン間の画面遷移（例: app → admin）は、Server Actionが直接`redirect()`でやらず、クライアントが行う。
- Server Actionは「次にどのURLへ行けばいいか」だけを返す。

---

## フロントエンド側の責務

- UIは「Server Actionから返ってきた結果」をもとに状態更新や画面遷移を行う。
- UI側で勝手に権限付け替えやorg差し替えをしない。
- 例外が必要な場合は、まずADRを書く。勝手に「暫定でこうしましょうか？」と権限を上げるコードを提案しない。

---

## テストとの整合性

- フロントエンドのボタンやリンクには、`role` / `aria-label` / `name` で識別できるテキストを必ず持たせる。
- CSSクラス名（`.foo-123` のようなもの）に依存してPlaywrightで拾わせるようなUIは作らない。
- Firefox / WebKit でも安定する形での遷移・レンダリング待ちを想定しておく。

---

## まとめ

- Server Actionは「ロジックと結果オブジェクト」まで。画面遷移はクライアント。
- 権限はサーバ側・DB側で最終確認。クライアントの主張は信じない。
- マルチドメイン前提を崩さない。
- アクセシビリティに基づくセレクタを前提にUIを書く。

この方針から外れる場合は、まずADRを作ってから議論すること。