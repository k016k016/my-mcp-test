# CLAUDE.md

このファイルは、Claude Code (claude.ai/code) がこのリポジトリで作業する際のガイドラインです。
勝手に実装を進めないこと。既存ルールを踏まえてから修正・提案すること。
PRやコード変更の前に、必ずこのファイルを読み直してください。

⸻

## プロジェクト概要

[このプロジェクトの目的と主な機能を記述してください]

⸻

## このファイルの目的

このドキュメントはClaude Codeに対して、以下を徹底させるためのものです。

* 新機能をいきなり実装しないこと
* 既存のアーキテクチャやルールを無視した「作り直し提案」をしないこと
* 危険な箇所（middleware.ts、認証フローなど）に気軽に手を入れないこと

このガイドラインに従わない提案や変更は受け入れません。

⸻

## 🚨 必須セットアップ（最重要）

### ローカル開発環境では `.local.test` ドメインを使用すること

**このプロジェクトは `localhost` ではなく `.local.test` ドメインでの動作を前提としています。**

#### hostsファイル設定（例）

/etc/hosts に以下のようにローカルドメインを割り当てること。
`<APP_DOMAIN>` / `<ADMIN_DOMAIN>` / `<OPS_DOMAIN>` はプロジェクトごとに決める。
`<BASE_LOCAL_SUFFIX>` はサフィックス（例: `.local.test`）。

例:
```bash
# /etc/hosts (macOS/Linux) または C:\Windows\System32\drivers\etc\hosts (Windows)
127.0.0.1 app.local.test    # <APP_DOMAIN> (= app<BASE_LOCAL_SUFFIX>)
127.0.0.1 admin.local.test  # <ADMIN_DOMAIN> (= admin<BASE_LOCAL_SUFFIX>)
127.0.0.1 ops.local.test    # <OPS_DOMAIN> (= ops<BASE_LOCAL_SUFFIX>)
```

#### なぜ必須なのか

* Cookie共有: サブドメイン間で認証状態を共有するため
* マルチドメイン構成: `<APP_DOMAIN>`, `<ADMIN_DOMAIN>` などドメインごとに役割が分かれている
* 本番環境との一貫性: 本番環境と同じマルチドメイン構成を再現

#### .env.local（必須）

この値を正とする。E2Eやアプリのコードは .env.local を参照し、ハードコードしないこと。

```bash
NEXT_PUBLIC_COOKIE_DOMAIN=.local.test          # <BASE_LOCAL_SUFFIX>
NEXT_PUBLIC_APP_URL=http://app.local.test:3000 # <APP_DOMAIN>
NEXT_PUBLIC_ADMIN_URL=http://admin.local.test:3000 # <ADMIN_DOMAIN>
NEXT_PUBLIC_OPS_URL=http://ops.local.test:3000     # <OPS_DOMAIN>
```

**重要**: `localhost` で動作させると、Cookie共有が機能せず、認証が正しく動作しません。

⸻

## 重要なルール

### 実装前の確認

新機能や大きな変更を実装する前に、必ず以下を確認してください：

1. [実装前チェックリスト](./docs/checklists/pre-implementation.md) を実施
2. [パターンカタログ](./docs/patterns/README.md) で関連パターンを確認
3. [テストデータ設計](./docs/test-data/README.md) を確認

   * テストデータの型・ダミー値・権限パターンを無視した実装は禁止

これらの確認なしで「こう書き換えました」「こうすると楽です」という提案は不要です。

⸻

## 禁止事項（壊れやすい領域）

以下は勝手にいじってはいけない領域です。理由のない変更提案も禁止します。

* middleware.ts の挙動（特にリダイレクトやドメイン判定）を書き換えないこと

  * ドメインごとのアクセス制御やセッション更新は非常に壊れやすい
  * middleware.ts を編集する提案をする場合、必ず次をセットで提示すること：

    * なぜ必要か（不具合・要件・仕様変更のどれか）
    * 影響範囲（認証 / リダイレクト / サブドメイン切替）
    * 代替案（触らずに回避できる方法）
      これが無い提案は却下する。
* 認証フロー（サインイン/サインアップ/組織切替）のURL、リダイレクト先、ドメイン判定ロジックを変更しないこと
* Server Action内で `redirect()` を使う提案をしないこと

  * マルチドメイン環境では不安定なため禁止
  * **例外は一切ない。同一ドメイン内でも`redirect()`は全面禁止**
* 環境依存の値（ドメイン、URL、Cookieドメインなど）をコードやテストにハードコードしないこと

  * ❌ `const baseUrl = 'http://app.local.test:3000'`
  * ✅ `const baseUrl = process.env.NEXT_PUBLIC_APP_URL`
  * E2Eテストも同様。`.env.local` を唯一の正として参照すること
  * これを守らないPRは拒否してよい
* RLS/権限チェックをスキップする一時対応を提案しないこと

  * 例: 「まずは全件取得してクライアント側でフィルタでいいのでは？」はNG
* 環境変数名を勝手に追加・変更しないこと

  * 新しい環境変数を導入したい場合は `./docs/decisions/` にADRを追加する提案から入ること
* 監査・ログ系のロジックを勝手に削除／短絡化しないこと

これらを変更したい場合は、なぜ必要なのか、どの既存仕様と衝突するのか、どのADRに追記すべきかまでセットで提案してください。

⸻

## TDD（テスト駆動開発）

このプロジェクトでは、新機能はTDDで実装します。

TDDサイクル：

1. Red（失敗）: 先にテストを書く。まだ実装がないのでテストが失敗することを確認する
2. Green（成功）: 最小限の実装でテストを通す
3. Refactor（改善）: テストが通る状態を維持したままリファクタする

Claudeへの追加ルール：

* 一度に最終実装まで書かないこと
* まずは「失敗するテストファイル」だけを提示し、その次に最小実装を提示すること
* Red → Green → Refactor を1ステップで省略しないこと

  * 「完成版を書きました。ついでにリファクタしました」は禁止

⸻

## Server Actions実装時のルール

Server Actionを追加・変更する場合は、必ず[Server Actionsパターン](./docs/patterns/server-actions.md) を参照してください。

特に重要：

* ❌ `redirect()` は使わない

  * マルチドメイン環境では不安定なため禁止
  * **例外は一切ない。同一ドメイン内でも全面禁止**
* ✅ Server Actionは「結果のデータ（成功or失敗、次に遷移すべきURLなど）」を返す
* ✅ 実際の画面遷移はクライアント側で `router.push()` を用いて行う

つまり、サーバー側は「状態更新と結果を返す」まで、ルーティングの最終決定はクライアント側の責務。

⸻

## E2Eテスト作成時のルール

E2Eテストを作成・修正する場合は、必ず[E2Eテストパターン](./docs/patterns/e2e-testing.md) を参照してください。

### E2Eテスト用のログイン方式について

* ✅ **ADR-003で定義されたE2E専用の認証バイパス機構**を使用してログイン済み状態を再現してよい
  * 本番用の認証フロー（メールログイン/SSO等）を毎回踏む必要はない
  * テストの安定性と速度向上のための公式手段
  * このバイパスはE2E専用。本番やステージング本番相当では無効であることが前提
* ❌ **自作の権限緩和は全面禁止**
  * `middleware`を緩める/RLSを外す/`if (TEST) { return admin }`みたいな独自の抜け道を勝手に作る提案はすべて禁止
  * 使っていいのは公式に定義されたE2Eログインバイパスだけ
  * 本番・ステージング本番相当環境では絶対に無効であることが前提

### その他の重要ルール

* ✅ `role` 属性などアクセシビリティベースのセレクタで要素を検索する

  * CSSセレクタ（`.class` や複雑な `div > span:nth-child(2)` など）は避ける
* ✅ Firefoxの場合は `waitForLoadState('domcontentloaded')` を入れる

  * Chromiumだけで安定してもFirefox/WebKitで落ちるケースがある
* ✅ ダイアログ（確認ダイアログ、アラートなど）のハンドラ登録は **クリック前** に行う

  * クリック後に `page.on('dialog', ...)` を登録するのは遅いのでNG

⸻

## テスト配置・命名ルール

Claudeがテストを書くときはこの配置・命名を守ること。

### ユニットテスト

* 配置:
  `src/<対象ディレクトリ>/__tests__/<対象ファイル>.test.ts`
* 対象ファイルと同じドメイン・同じ関心ごとを扱うこと
* そのモジュールのI/Oとバリデーションを確認すること（副作用はモックする）

### E2Eテスト

* 配置:
  `e2e/<ドメイン名>.spec.ts`

  * 例: `e2e/organization-switching.spec.ts`
  * 例: `e2e/app-domain.spec.ts`

### describe/test の命名

* `"<ドメイン> - <機能> › <シナリオ> › <期待される結果>"` の3階層で書く

  * 例:

    * `組織切り替え - AUTH_FLOW_SPECIFICATION準拠 › 権限がない組織への切り替え › エラー表示`
    * `OPSドメイン - 運用ダッシュボード › ダッシュボード表示 › 正しく表示される`

この命名はログとレポートの可読性のために必須。

⸻

## 開発コマンド

### ビルド

```bash
npm run build
```

### テスト

```bash
npm run test
```

```bash
npm run test:e2e
```

### リント

```bash
npm run lint
```

### ローカル実行

```bash
npm run dev
```

⸻

## アーキテクチャ（現時点の前提）

このプロジェクトは以下を前提として設計されている。この前提を「もっと綺麗に整理しました」といって勝手に壊さないこと。

### マルチドメイン構成

* Next.js App Routerベース
* `<APP_DOMAIN>`, `<ADMIN_DOMAIN>`, `<OPS_DOMAIN>` など、ドメインごとに役割が分かれている

  * 例: 一般ユーザー向けUI / 運用ダッシュボード / 管理コンソール など
* ドメインによってアクセス可能な機能や権限が異なる

### Supabase（固定前提）

* **このテンプレートはSupabase専用**。認証・DB・RLSはSupabase前提で固定
* DB/RLS/Authのソースオブトゥルース
* プロファイルや権限はDB側が真実。フロント側の一時的な状態を信用しない
* RLSや権限チェックを外す提案は禁止
* 他のIDP（Auth0、Firebase等）への抽象化は行わない

### middleware.ts

* リクエストごとにセッションを更新し、ドメインごとのルールを適用する
* 認証状態によって特定のページへのアクセスを制御する
* 非常に壊れやすいので、基本的に触らない
* どうしても修正する場合は、なぜ必要か、どの既存仕様と競合するか、影響範囲（認証/リダイレクト/サブドメイン）を明記して提案すること

### Server Actions

* 画面から発生するビジネスロジック（DB更新・権限チェックなど）はServer Actionで処理する
* Server Actionは「処理結果（成功/失敗、次に遷移すべきURLなど）」だけを返す
* 遷移そのもの（`router.push` など）はクライアント側の責務
* `redirect()`は全面禁止（例外なし。同一ドメイン内でも禁止）

⸻

## テストデータ運用ルール（E2E / 統合テスト）

**このテンプレートはマルチテナントSaaS前提**。E2Eテストや統合テストでは、データの作成・削除まわりで環境が壊れやすい。以下のルールは厳守すること。

### 固定アカウント／固定組織を使うこと

* すでにDBにseed済みのテスト用ユーザ・組織を使うこと。

  * 例:

    * `test_user_basic@example.com`（一般ユーザ）
    * `test_user_admin@example.com`（管理画面アクセス可）
    * `test_user_ops@example.com`（運用ダッシュボード用）
    * `test_org_alpha`, `test_org_beta`（組織切替テスト用）
* これらの権限・所属関係が仕様そのものなので、勝手に変更しない提案をしないこと。
* **マルチテナントSaaSの組織ロール（owner/admin/member）は固定仕様**

  * 例: 「全部の権限を1アカウントにまとめました」は禁止。

### 既存データを消そうとしないこと

* 既に存在するユーザや組織を `DELETE` するテストは書かない。
* 「一旦クリーンアップしてからテストします」という形で本体データを削除しようとしない。
* 削除フロー自体を検証したい場合はユニットテスト（モック）で行う。E2Eではやらない。

理由：

* 一度でも削除に失敗すると、CIやローカルでテストが再実行できなくなる。
* 削除に権限/外部制約が入っている場合、無限ループやリトライ地獄になる。

### サインアップ系テストだけは例外で「一時ユーザ」を作ってよい

* 新規登録フローそのもの（サインアップ画面～初回プロフィール設定など）を検証するE2Eだけ、動的ユーザ作成を許可する。
* その場合、メールアドレスは毎回ユニークにすること。

  * 形式ルール：

    * `e2e+<yyyyMMddHHmmss>@example.com`
    * 例: `e2e+20251025T130455@example.com`
* 同じメールを再利用しないこと。
* 既存ユーザを削除して再利用しようとしないこと。

理由：

* 「すでに登録済みなのでサインアップできません」で毎回Redになる事故を防ぐ。

### 権限をテスト中に付け替えないこと

* E2E内で「一時的にadmin権限を付与してからこの画面にアクセスする」という書き方は禁止。
* 代わりに、最初からadmin権限を持っているseed済みアカウントでログインするテストケースと、権限のないアカウントでログインするテストケースを分けること。

理由：

* 権限変更は監査対象ロジック（監査ログ、承認フロー）と絡むため、そこをテストの副作用でいじると本番運用とズレる。

### DBリセットについて

* `TRUNCATE` や「全部DROPしてmigrateし直す」など、テスト内からDB全初期化を行う提案は禁止。
* 将来的に `npm run test:e2e` の前にテスト用DBを初期状態に戻す公式スクリプト（例：`scripts/reset-e2e-db.ts`）を用意する想定。
* もしそのスクリプトが存在する場合は、必ずそれを使う提案をすること。それ以外のリセット方法を勝手に提案しない。

⸻

## トラブルシューティング

問題が発生したら、まず以下を確認すること：

1. [トラブルシューティング](./docs/troubleshooting/README.md)
2. 直近でmiddlewareやAuthまわりを変更していないか
3. Supabaseの権限/RLSまわりの変更が入っていないか
4. テストでFirefox/WebKit固有の待機を省略していないか

E2Eがローカルでは通るがCIで落ちる場合、だいたいは待機不足か、roleセレクタ不使用。

⸻

## ADR（設計判断記録）

重要な設計判断は、[ADR](./docs/decisions/README.md) に記録してください。

新しい環境変数、APIの責務変更、権限モデルの変更、ドメイン間のリダイレクト条件などは、すべてADRに追記すること。
ADRに反映できない提案は却下します。

⸻

## Claudeへの期待する振る舞い

Claudeがコードを提案・修正するときは、以下を守ってください：

* いきなり全面リファクタを提案しない

  * 局所的な修正で済むなら局所的に直すこと
* 「まず全件取得してあとで最適化」など、セキュリティやRLSを無視する一時しのぎを提案しない
* `middleware.ts` を編集する場合、理由・影響範囲・代替案 を必ずセットで提示する
* 新しい環境変数を増やす場合、ADR更新案も必ず書く

⸻

#いい。今のCLAUDE.mdはもう十分厳しい。ここに「技術スタック / 外部サービス（変更禁止事項）」を末尾に1セクションとして足せば完成でいい。

以下そのままコピペで一番下に追加して。

⸻

技術スタック / 外部サービス（変更禁止事項）

このプロジェクトは、下記のスタックと運用前提で設計されている。
勝手な置き換え・簡略化・一時バイパスの提案は受け付けない。変更したい場合は必ず ./docs/decisions/ にADRを追加すること。

フレームワーク / ランタイム
	•	Next.js (App Router)
	•	Server Actionsを使用する
	•	redirect() は全面禁止（例外なし。同一ドメインでも禁止）
	•	Server Actionは「状態更新」と「結果（ActionResult）を返す」ところまで
	•	画面遷移はクライアント側で行う（router.push() / location.assign()）
	•	データ変更後は revalidatePath() でキャッシュ再検証する
	•	「フロント側のstateを一時的に書き換えてごまかすからrevalidate不要」は禁止

Server Action の返り値フォーマット（固定ルール）

すべてのServer Actionはこの型を返すこと。独自の戻り値型を生やさないこと。

export type ActionResult<T> =
  | { success: true; data?: T; nextUrl?: string }
  | { success: false; error: string; nextUrl?: string }

	•	success が true/false でフロント側の分岐が確定する
	•	data は成功時の結果データ
	•	error は失敗理由
	•	現時点ではメッセージ文字列を返してよい
	•	ただし将来的に errorCode ベースに変更する可能性がある
→ UIはこの文字列にハード依存しすぎないこと（サーバーの文面をそのままUIに焼き付けるな）
	•	nextUrl は「次に遷移すべき場所」
	•	相対パスでもフルURLでもよい
	•	相対パス: 同一ドメイン遷移 → router.push(nextUrl)
	•	フルURL: 別ドメイン遷移 → location.assign(nextUrl)
	•	失敗時でも返してよい（例：権限不足時にエラーページへ誘導する）

禁止事項:
	•	Server Action内で redirect() を呼ぶ提案
	•	成功時だけ { nextUrl: ... } を返して、失敗時は別フォーマットにする提案
	•	新しいshapeのResult型を勝手に作る提案

Supabase（DB / 認証 / RLS）
	•	認証・DB・RLSはSupabaseを正とする。これはプロジェクトの前提であり交渉不可
	•	Supabase Authのユーザ情報が唯一のソースオブトゥルース
	•	Row Level Security (RLS) は常に有効
	•	このプロジェクトはマルチテナントSaaS前提であり、organization_id がテナント境界キー
	•	すべての読み書きで organization_id を明示的に扱うこと
	•	.eq('organization_id', orgId) 等のチェックを省略しないこと
	•	insert時も organization_id: orgId を必ず入れること
	•	アプリケーション側でも権限チェックを行う
（RLS任せにしない / 「RLSが弾くからOKでしょ」は禁止）

禁止事項:
	•	RLSを外す提案
	•	middlewareで「テスト時だけ全員admin扱い」みたいな提案
	•	「まずは権限ゆるめて動くところまでいきましょう」という提案

これらはすべてADRなしでは不許可。

マルチテナント権限モデル
	•	組織ロールは owner / admin / member
	•	1つの組織には必ず owner が存在する
→ owner不在の組織を作るのは禁止
	•	ops は運用用の別軸ロール。owner / admin / member と混ぜないこと
	•	E2Eや開発のために「一時的にこのユーザをowner相当で扱いましょう」は禁止

禁止事項:
	•	member をテスト中だけ ops 相当扱いする
	•	owner を削除して「ownerゼロの組織」を検証する
	•	既存のseedユーザ/seed組織のロールを勝手に変えるテスト

権限モデルを変えたい場合は、どのロール定義が変わるか、既存仕様どこに衝突するか、監査ログにどう影響するかを含めてADRを書くこと。

ドメイン / Cookie モデル
	•	ローカルは複数ドメイン運用が前提（<APP_DOMAIN>, <ADMIN_DOMAIN>, <OPS_DOMAIN> など）
	•	すべて同じサフィックス <BASE_LOCAL_SUFFIX>（例: .local.test）を持つ
	•	Cookieはこのサフィックスをドメインにしてサブドメイン間で共有する
	•	/etc/hosts にはこれらのドメインを 127.0.0.1 に向けて登録すること
例:
	•	127.0.0.1 app.local.test    # <APP_DOMAIN> (= app<BASE_LOCAL_SUFFIX>)
	•	127.0.0.1 admin.local.test  # <ADMIN_DOMAIN> (= admin<BASE_LOCAL_SUFFIX>)
	•	127.0.0.1 ops.local.test    # <OPS_DOMAIN> (= ops<BASE_LOCAL_SUFFIX>)
	•	.env.local はこう持つ（これが正）:

NEXT_PUBLIC_COOKIE_DOMAIN=<BASE_LOCAL_SUFFIX>
NEXT_PUBLIC_APP_URL=http://<APP_DOMAIN>:3000
NEXT_PUBLIC_ADMIN_URL=http://<ADMIN_DOMAIN>:3000
NEXT_PUBLIC_OPS_URL=http://<OPS_DOMAIN>:3000

ルール:
	•	localhost は禁止
	•	localhost だとサブドメイン間Cookie共有が再現できず、本番挙動とズレる
	•	E2E含むアプリコード内でURLを直書きしない
	•	Playwrightなどのテストは process.env.NEXT_PUBLIC_APP_URL 等からURLを組み立てる
	•	page.goto(process.env.NEXT_PUBLIC_APP_URL + '/login') のように書く
	•	URLやホスト名をハードコードしているPRは拒否してよい

キャッシュ / 再検証
	•	Server ActionでDBを変更した場合、必ず revalidatePath() を呼んでNext.js側のキャッシュを無効化すること
	•	「SWR/ローカルstateだけ更新しておきました。再検証しなくても一旦画面は正しく見えるので大丈夫です」は禁止
	•	キャッシュ戦略を変えたい場合は、その影響範囲（表示整合性・権限境界・別ドメイン表示への波及）を整理したADRが必要

E2Eテスト / CI
	•	テストはPlaywrightで書く
	•	Firefoxでも安定するように待機を入れる
	•	waitForLoadState('domcontentloaded') は必須
	•	要素取得は role ベースで行う
	•	CSSセレクタ直叩き（.class, div > span:nth-child(2) 等）は禁止
	•	ダイアログのハンドラはクリック前に登録すること
	•	後から page.on('dialog', ...) を付けるのは遅い

ログインについて（CI/E2E専用ルール）:
	•	ログイン画面を毎回踏む必要はない
	•	ADR-003で定義されたE2E専用ログインバイパスを使って、特定ユーザとしてログイン済み状態で開始してよい
	•	このバイパスはE2E専用。本番やステージング本番相当では無効でなければならない
	•	禁止事項:
	•	middlewareを緩める
	•	RLSを外す
	•	if (TEST) { return admin } 的な処理を提案する
	•	こういう「権限の一時バイパス」系の提案はすべて却下していい

URLについて:
	•	テストコードは .env.local の NEXT_PUBLIC_*_URL を参照してアクセスする
	•	http://app.local.test:3000 のようなURL直書きは不可

監査 / ログ
	•	監査ログ・操作ログの処理を削除・短絡化する提案は禁止
	•	「テストのために監査だけ一時的に外しました」は無効
	•	運用ダッシュボード（<OPS_DOMAIN> 側）での権限・監査ロジックを簡略化する場合は、なぜ必要か・影響範囲・代替案をセットにしたADRが必要

⸻

このセクションの扱い
	•	ここに書かれている前提を壊す提案はすべて「未承認」扱い
	•	本当に変えたい場合はADRを用意してから話すこと
	•	何を変えたいか
	•	既存仕様とどこが衝突するか
	•	影響範囲（認証 / 権限 / ドメイン / 監査 / キャッシュ / E2E）
	•	ロールバック手順
	•	ADRなしの「とりあえずこうしました」は却下する

このプロジェクトの優先順位は
	1.	壊れないこと
	2.	導入企業側のハードルを下げること
	3.	収益最大化
であり、「きれいだからそうしました」より「安全に再現できるのでそうします」を優先する。